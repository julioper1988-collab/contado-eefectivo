<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Control de Caja</title>
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,sans-serif;background:#0b1220;color:#eaf2ff}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .card{background:#0f1a2c;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;margin:12px 0}
    h1{margin:0 0 4px 0;font-size:22px}
    h2{margin:0 0 10px 0;font-size:18px}
    .muted{opacity:.75;font-size:13px}
    label{display:block;font-size:12px;opacity:.8;margin:10px 0 6px}
    input,select,button,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0a111c;color:#eaf2ff;outline:none;font-size:14px}
    textarea{min-height:80px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1;min-width:200px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media(max-width:740px){.grid{grid-template-columns:repeat(2,1fr)}}
    .denom{background:#0a111c;border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px}
    .denom .top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#0a111c}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap}
    .btnRow button{width:auto;flex:1;min-width:120px;cursor:pointer}
    .primary{background:#1c7ed6;border-color:rgba(255,255,255,.18)}
    .danger{background:#c92a2a;border-color:rgba(255,255,255,.18)}
    .warn{background:#d9480f;border-color:rgba(255,255,255,.18)}
    .success{background:#2b8a3e;border-color:rgba(255,255,255,.18)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:13px}
    th{text-align:left;opacity:.8}
    .right{text-align:right}
    .extra-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .extra-row input:first-child{flex:2}
    .extra-row input:nth-child(2){flex:1}
    .extra-row button{width:40px;min-width:40px;flex:none;padding:10px;border-radius:10px;background:#c92a2a;border-color:rgba(255,255,255,.18);cursor:pointer;font-size:16px}
    .sync-status{display:inline-flex;align-items:center;gap:6px;padding:5px 12px;border-radius:999px;font-size:12px;margin-top:8px}
    .sync-ok{background:rgba(43,138,62,.2);border:1px solid rgba(43,138,62,.4);color:#69db7c}
    .sync-err{background:rgba(201,42,42,.2);border:1px solid rgba(201,42,42,.4);color:#ff8787}
    .sync-loading{background:rgba(28,126,214,.2);border:1px solid rgba(28,126,214,.4);color:#74c0fc}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    .spinner{display:inline-block;width:12px;height:12px;border:2px solid rgba(255,255,255,.3);border-top-color:#74c0fc;border-radius:50%;animation:spin .6s linear infinite}
    .tabs{display:flex;gap:0;margin:12px -14px 0 -14px}
    .tab{flex:1;padding:14px;text-align:center;cursor:pointer;font-size:15px;font-weight:600;border:1px solid rgba(255,255,255,.08);background:#0a111c;color:rgba(234,242,255,.5);transition:all .2s}
    .tab:first-child{border-radius:0 0 0 0}
    .tab:last-child{border-radius:0 0 0 0}
    .tab.active{background:#1c7ed6;color:#fff;border-color:rgba(255,255,255,.18)}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .modal-bg{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.75);z-index:100;align-items:center;justify-content:center;padding:16px}
    .modal-bg.show{display:flex}
    .modal{background:#0f1a2c;border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:20px;max-width:500px;width:100%;max-height:85vh;overflow-y:auto}
    .modal h2{margin:0 0 14px 0;font-size:20px}
    .sum-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.06);font-size:14px}
    .sum-row b{opacity:.7;font-weight:400}
    .sum-row .val{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .sum-section{margin:14px 0 6px;font-size:12px;opacity:.45;text-transform:uppercase;letter-spacing:1px}
    .sum-total{font-size:18px;font-weight:700;border-top:2px solid rgba(255,255,255,.15);padding-top:12px;margin-top:12px}
    .modal .btnRow{margin-top:16px}
    .date-nav{display:flex;gap:6px;align-items:center}
    .date-nav button{width:42px;min-width:42px;flex:none;padding:10px;font-size:16px;cursor:pointer;border-radius:10px}
    .date-nav input{flex:1}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" style="padding-bottom:0">
      <h1>Control de Caja</h1>
      <div class="muted">Sincronizado con la nube ‚òÅÔ∏è</div>
      <div id="syncStatus"></div>
      <div class="tabs">
        <div class="tab active" data-tab="carga">üìù Nuevo cierre</div>
        <div class="tab" data-tab="historial">üìã Historial</div>
      </div>
    </div>

    <!-- TAB CARGA -->
    <div id="tab-carga" class="tab-content active">
      <div class="card">
        <div class="row">
          <div>
            <label>Negocio / Caja</label>
            <input id="biz" placeholder="Ej: Bodega, Asaditos, Conteo general" />
          </div>
          <div>
            <label>Fecha</label>
            <div class="date-nav">
              <button id="prevDay">‚óÄ</button>
              <input id="date" type="date" />
              <button id="nextDay">‚ñ∂</button>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="pill"><b class="mono">Efectivo:</b> <span id="cashTotal" class="mono">0</span></div>
          <div class="pill"><b class="mono">Total general:</b> <span id="grandTotal" class="mono">0</span></div>
        </div>
      </div>
      <div class="card">
        <h2>Billetes</h2>
        <div id="billsGrid" class="grid"></div>
      </div>
      <div class="card">
        <h2>Monedas</h2>
        <div id="coinsGrid" class="grid"></div>
      </div>
      <div class="card">
        <h2>Otros montos</h2>
        <div class="row">
          <div><label>Bancos</label><input id="banks" inputmode="numeric" placeholder="0" /></div>
          <div><label>Tarjetas / POS</label><input id="cards" inputmode="numeric" placeholder="0" /></div>
          <div><label>Otros</label><input id="others" inputmode="numeric" placeholder="0" /></div>
        </div>
        <label>Detalle (opcional)</label>
        <textarea id="notes" placeholder="Ej: Ueno 1.200.000, Familiar 500.000..."></textarea>
      </div>
      <div class="card">
        <h2>Montos adicionales</h2>
        <div id="extraItems"></div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-top:10px">
          <button class="success" id="addExtraBtn" style="width:auto;padding:8px 16px;font-size:13px">Ôºã Agregar l√≠nea</button>
          <div class="pill"><b class="mono">Subtotal:</b> <span id="extrasTotal" class="mono">0</span></div>
        </div>
      </div>
      <div class="card">
        <div class="btnRow">
          <button class="primary" id="saveBtn">‚òÅÔ∏è Guardar cierre</button>
          <button class="success" id="newBtn">‚ú® Limpiar</button>
        </div>
      </div>
    </div>

    <!-- TAB HISTORIAL -->
    <div id="tab-historial" class="tab-content">
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px">
          <h2 style="margin:0">Cierres guardados</h2>
          <button class="primary" id="refreshBtn" style="width:auto;padding:8px 16px;font-size:13px">üîÑ Actualizar</button>
        </div>
        <div class="row" style="margin-bottom:10px">
          <div><label>Filtrar por negocio</label><input id="filterBiz" placeholder="Todos" /></div>
          <div><label>Filtrar por fecha</label><input id="filterDate" type="date" /></div>
          <div style="display:flex;align-items:flex-end"><button class="warn" id="clearFilterBtn" style="padding:12px;font-size:13px">Limpiar filtros</button></div>
        </div>
        <table>
          <thead><tr><th>Fecha</th><th>Negocio</th><th class="right">Total</th><th class="right">Acci√≥n</th></tr></thead>
          <tbody id="histBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- MODAL RESUMEN -->
  <div class="modal-bg" id="summaryModal">
    <div class="modal">
      <h2 id="sumTitle">Resumen del cierre</h2>
      <div id="sumContent"></div>
      <div class="btnRow">
        <button class="primary" id="sumEditBtn">‚úèÔ∏è Editar</button>
        <button class="warn" id="sumCloseBtn">Cerrar</button>
        <button class="danger" id="sumDeleteBtn">üóëÔ∏è Borrar</button>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
  const SUPABASE_URL="https://gqgzluwptmgvzdewjusp.supabase.co";
  const SUPABASE_KEY="sb_publishable_Gic4Jhw3keO6MyZtKV2nZA_jjXYiCnJ";
  let sb;
  try{sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY)}catch(e){console.error(e)}
  const TABLE="caja_cierres";
  const $=id=>document.getElementById(id);
  const fmt=n=>(Number(n||0)).toLocaleString("es-PY");
  const BILLS=[100000,50000,20000,10000,5000,2000,1000,500,100];
  const COINS=[1000,500,100,50];
  let currentModalRec=null;

  function todayISO(){const d=new Date();return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")}
  function keyOf(date,biz){return date+"__"+(biz||"").trim().toLowerCase()}
  function numVal(v){const s=String(v||"").replaceAll(".","").replaceAll(",","").trim();const n=s===""?0:Number(s);return Number.isFinite(n)?n:0}
  function errMsg(e){if(!e)return"Error desconocido";if(typeof e==="string")return e;if(e.message)return e.message;if(e.details)return e.details;if(e.hint)return e.hint;try{return JSON.stringify(e)}catch(_){return"Error desconocido"}}
  function showSync(type,msg){
    const el=$("syncStatus");
    if(type==="ok")el.innerHTML='<div class="sync-status sync-ok">‚úì '+msg+'</div>';
    else if(type==="err")el.innerHTML='<div class="sync-status sync-err">‚úó '+msg+'</div>';
    else if(type==="loading")el.innerHTML='<div class="sync-status sync-loading"><span class="spinner"></span> '+msg+'</div>';
    else el.innerHTML='';
  }

  // Tabs
  document.querySelectorAll(".tab").forEach(tab=>{
    tab.addEventListener("click",()=>{
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
      tab.classList.add("active");
      $("tab-"+tab.dataset.tab).classList.add("active");
      if(tab.dataset.tab==="historial")renderHistory();
    });
  });
  function switchToTab(name){
    document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active",t.dataset.tab===name));
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
    $("tab-"+name).classList.add("active");
  }

  // Date nav
  function shiftDate(days){
    const d=new Date($("date").value||todayISO());
    d.setDate(d.getDate()+days);
    $("date").value=d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");
    updateTotals();
  }
  $("prevDay").addEventListener("click",()=>shiftDate(-1));
  $("nextDay").addEventListener("click",()=>shiftDate(1));

  // Grid
  function buildGrid(cid,denoms,prefix){
    const grid=$(cid);grid.innerHTML="";
    denoms.forEach(d=>{
      const w=document.createElement("div");w.className="denom";
      w.innerHTML='<div class="top"><div class="pill"><b class="mono">'+fmt(d)+'</b></div><div class="pill"><span class="mono" id="'+prefix+'_t_'+d+'">0</span></div></div><label style="margin-top:10px">Cantidad</label><input id="'+prefix+'_c_'+d+'" inputmode="numeric" placeholder="0" />';
      grid.appendChild(w);
      const inp=w.querySelector("#"+prefix+"_c_"+d);
      inp.addEventListener("input",updateTotals);
      inp.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();focusNextInput(inp)}});
    });
  }
  function allInputs(){return Array.from(document.querySelectorAll("#tab-carga input,#tab-carga textarea")).filter(el=>!el.disabled&&el.type!=="hidden"&&el.offsetParent!==null)}
  function focusNextInput(cur){const l=allInputs();const i=l.indexOf(cur);if(i>=0&&i<l.length-1)l[i+1].focus()}
  function getCounts(p,d){const o={};d.forEach(v=>{o[v]=numVal($(p+"_c_"+v).value)});return o}
  function setCounts(p,d,c){d.forEach(v=>{$(p+"_c_"+v).value=(c&&c[v]!=null)?String(c[v]):""})}
  function sumCounts(d,c){let t=0;d.forEach(v=>{t+=Number(v)*numVal(c[v])});return t}

  // Extra items
  let extraCounter=0;
  function addExtraItem(concepto,monto){
    extraCounter++;
    const container=$("extraItems");
    const row=document.createElement("div");row.className="extra-row";
    const cInp=document.createElement("input");cInp.type="text";cInp.placeholder="Concepto (ej: Ueno)";cInp.value=concepto||"";
    const mInp=document.createElement("input");mInp.type="text";mInp.inputMode="numeric";mInp.placeholder="Monto";mInp.value=monto?String(monto):"";
    const del=document.createElement("button");del.type="button";del.textContent="‚úï";
    row.appendChild(cInp);row.appendChild(mInp);row.appendChild(del);
    container.appendChild(row);
    mInp.addEventListener("input",updateTotals);
    del.addEventListener("click",()=>{row.remove();updateTotals()});
    cInp.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();mInp.focus()}});
    mInp.addEventListener("keydown",e=>{
      if(e.key==="Enter"){
        e.preventDefault();
        const rows=Array.from(document.querySelectorAll("#extraItems .extra-row"));
        const idx=rows.indexOf(row);
        if(idx<rows.length-1){rows[idx+1].querySelector("input").focus()}
        else{const nr=addExtraItem("","");nr.querySelector("input").focus()}
      }
    });
    updateTotals();
    return row;
  }
  function getExtraItems(){const items=[];document.querySelectorAll("#extraItems .extra-row").forEach(r=>{const inp=r.querySelectorAll("input");const c=(inp[0].value||"").trim();const m=numVal(inp[1].value);if(c||m)items.push({concepto:c,monto:m})});return items}
  function setExtraItems(items){$("extraItems").innerHTML="";extraCounter=0;(items||[]).forEach(it=>addExtraItem(it.concepto,it.monto||0))}
  function sumExtras(){let t=0;document.querySelectorAll("#extraItems .extra-row").forEach(r=>{t+=numVal(r.querySelectorAll("input")[1].value)});return t}

  // Totals
  function updateTotals(){
    const bills=getCounts("b",BILLS),coins=getCounts("m",COINS);
    BILLS.forEach(d=>{$("b_t_"+d).textContent=fmt(Number(d)*numVal(bills[d]))});
    COINS.forEach(d=>{$("m_t_"+d).textContent=fmt(Number(d)*numVal(coins[d]))});
    const cash=sumCounts(BILLS,bills)+sumCounts(COINS,coins);
    const banks=numVal($("banks").value),cards=numVal($("cards").value),others=numVal($("others").value),extras=sumExtras();
    $("cashTotal").textContent=fmt(cash);
    $("extrasTotal").textContent=fmt(extras);
    $("grandTotal").textContent=fmt(cash+banks+cards+others+extras);
  }

  // Record
  function currentRecord(){
    const biz=$("biz").value.trim()||"Caja",date=$("date").value||todayISO();
    const bills=getCounts("b",BILLS),coins=getCounts("m",COINS);
    const banks=numVal($("banks").value),cards=numVal($("cards").value),others=numVal($("others").value);
    const notes=$("notes").value||"",extras=getExtraItems(),extrasTotal=sumExtras();
    const cash=sumCounts(BILLS,bills)+sumCounts(COINS,coins);
    return{record_id:keyOf(date,biz),fecha:date,negocio:biz,bills,coins,bancos:banks,tarjetas:cards,otros:others,notas:notes,extras,extras_total:extrasTotal,efectivo:cash,total:cash+banks+cards+others+extrasTotal,updated_at:new Date().toISOString()};
  }
  function loadRecord(rec){
    $("biz").value=rec.negocio||"";$("date").value=rec.fecha||todayISO();
    setCounts("b",BILLS,rec.bills||{});setCounts("m",COINS,rec.coins||{});
    $("banks").value=(rec.bancos||rec.banks)?String(rec.bancos||rec.banks):"";
    $("cards").value=(rec.tarjetas||rec.cards)?String(rec.tarjetas||rec.cards):"";
    $("others").value=(rec.otros||rec.others)?String(rec.otros||rec.others):"";
    $("notes").value=rec.notas||rec.notes||"";
    setExtraItems(rec.extras||[]);updateTotals();
  }
  function clearForm(){
    setCounts("b",BILLS,{});setCounts("m",COINS,{});
    $("banks").value="";$("cards").value="";$("others").value="";$("notes").value="";$("biz").value="";$("date").value=todayISO();
    setExtraItems([]);updateTotals();window.scrollTo({top:0,behavior:"smooth"});
  }

  // Summary modal
  function showSummary(rec){
    currentModalRec=rec;
    $("sumTitle").textContent=rec.negocio+" ‚Äî "+rec.fecha;
    let h='';
    const be=Object.entries(rec.bills||{}).filter(([,v])=>v>0);
    if(be.length){h+='<div class="sum-section">Billetes</div>';be.forEach(([d,c])=>{h+='<div class="sum-row"><b>'+fmt(d)+' √ó '+c+'</b><span class="val">'+fmt(Number(d)*c)+'</span></div>'})}
    const ce=Object.entries(rec.coins||{}).filter(([,v])=>v>0);
    if(ce.length){h+='<div class="sum-section">Monedas</div>';ce.forEach(([d,c])=>{h+='<div class="sum-row"><b>'+fmt(d)+' √ó '+c+'</b><span class="val">'+fmt(Number(d)*c)+'</span></div>'})}
    h+='<div class="sum-row" style="font-weight:600;border-top:1px solid rgba(255,255,255,.1);padding-top:8px;margin-top:6px"><b>Efectivo</b><span class="val">'+fmt(rec.efectivo||0)+'</span></div>';
    if((rec.bancos||0)>0||(rec.tarjetas||0)>0||(rec.otros||0)>0){
      h+='<div class="sum-section">Otros montos</div>';
      if(rec.bancos)h+='<div class="sum-row"><b>Bancos</b><span class="val">'+fmt(rec.bancos)+'</span></div>';
      if(rec.tarjetas)h+='<div class="sum-row"><b>Tarjetas</b><span class="val">'+fmt(rec.tarjetas)+'</span></div>';
      if(rec.otros)h+='<div class="sum-row"><b>Otros</b><span class="val">'+fmt(rec.otros)+'</span></div>';
    }
    const ex=rec.extras||[];
    if(ex.length){h+='<div class="sum-section">Montos adicionales</div>';ex.forEach(it=>{h+='<div class="sum-row"><b>'+it.concepto+'</b><span class="val">'+fmt(it.monto)+'</span></div>'});h+='<div class="sum-row" style="font-weight:600"><b>Subtotal adicionales</b><span class="val">'+fmt(rec.extras_total||0)+'</span></div>'}
    if(rec.notas){h+='<div class="sum-section">Notas</div><div style="font-size:13px;opacity:.8;white-space:pre-wrap;padding:6px 0">'+rec.notas+'</div>'}
    h+='<div class="sum-row sum-total"><b>TOTAL GENERAL</b><span class="val" style="color:#69db7c">Gs. '+fmt(rec.total||0)+'</span></div>';
    $("sumContent").innerHTML=h;
    $("summaryModal").classList.add("show");
  }
  $("sumCloseBtn").addEventListener("click",()=>{$("summaryModal").classList.remove("show");currentModalRec=null});
  $("summaryModal").addEventListener("click",e=>{if(e.target===$("summaryModal")){$("summaryModal").classList.remove("show");currentModalRec=null}});
  $("sumEditBtn").addEventListener("click",()=>{
    if(!currentModalRec)return;
    loadRecord(currentModalRec);
    $("summaryModal").classList.remove("show");
    switchToTab("carga");
    window.scrollTo({top:0,behavior:"smooth"});
  });
  $("sumDeleteBtn").addEventListener("click",async()=>{
    if(!currentModalRec)return;
    if(!confirm("¬øBorrar cierre "+currentModalRec.fecha+" ¬∑ "+currentModalRec.negocio+"?"))return;
    showSync("loading","Borrando...");
    try{
      const{error}=await sb.from(TABLE).delete().eq("record_id",currentModalRec.record_id);
      if(error)throw error;
      showSync("ok","Borrado: "+currentModalRec.fecha+" ¬∑ "+currentModalRec.negocio);
      $("summaryModal").classList.remove("show");currentModalRec=null;
      await renderHistory();
    }catch(e){showSync("err","Error: "+errMsg(e))}
  });

  // Save
  async function saveToCloud(){
    const rec=currentRecord();
    if(rec.total===0&&!confirm("El total es 0. ¬øGuardar?"))return;
    showSync("loading","Guardando...");
    try{
      const{data:existing}=await sb.from(TABLE).select("record_id").eq("record_id",rec.record_id).maybeSingle();
      let result;
      if(existing)result=await sb.from(TABLE).update(rec).eq("record_id",rec.record_id);
      else result=await sb.from(TABLE).insert(rec);
      if(result.error)throw result.error;
      showSync("ok","‚úì Guardado: "+rec.fecha+" ¬∑ "+rec.negocio+" ¬∑ Gs. "+fmt(rec.total));
      clearForm();
    }catch(e){console.error("Save:",e);showSync("err","Error: "+errMsg(e))}
  }

  // History
  async function renderHistory(){
    const body=$("histBody");
    const fBiz=($("filterBiz").value||"").trim().toLowerCase();
    const fDate=$("filterDate").value||"";
    try{
      let q=sb.from(TABLE).select("record_id,fecha,negocio,total").order("fecha",{ascending:false}).limit(100);
      if(fDate)q=q.eq("fecha",fDate);
      const{data,error}=await q;if(error)throw error;
      let items=data||[];
      if(fBiz)items=items.filter(r=>(r.negocio||"").toLowerCase().includes(fBiz));
      body.innerHTML="";
      if(!items.length){body.innerHTML='<tr><td colspan="4" style="text-align:center;opacity:.5;padding:20px">No hay cierres</td></tr>';return}
      items.forEach(rec=>{
        const tr=document.createElement("tr");
        tr.innerHTML="<td>"+rec.fecha+"</td><td>"+rec.negocio+"</td>"+'<td class="right mono">'+fmt(rec.total||0)+"</td>"+'<td class="right"><button data-id="'+rec.record_id+'" style="padding:8px 12px;border-radius:10px;cursor:pointer;background:#1c7ed6;border-color:rgba(255,255,255,.18)">üëÅÔ∏è Ver</button></td>';
        body.appendChild(tr);
      });
      body.querySelectorAll("button").forEach(btn=>{
        btn.addEventListener("click",async()=>{
          try{
            const{data:rec,error}=await sb.from(TABLE).select("*").eq("record_id",btn.dataset.id).maybeSingle();
            if(error)throw error;if(rec)showSummary(rec);
          }catch(e){showSync("err","Error: "+errMsg(e))}
        });
      });
    }catch(e){console.error("History:",e);body.innerHTML='<tr><td colspan="4" style="color:#ff8787">Error: '+errMsg(e)+'</td></tr>'}
  }

  // Filters
  let ft;
  $("filterBiz").addEventListener("input",()=>{clearTimeout(ft);ft=setTimeout(renderHistory,400)});
  $("filterDate").addEventListener("change",renderHistory);
  $("clearFilterBtn").addEventListener("click",()=>{$("filterBiz").value="";$("filterDate").value="";renderHistory()});

  // Init
  $("date").value=todayISO();
  buildGrid("billsGrid",BILLS,"b");
  buildGrid("coinsGrid",COINS,"m");
  ["banks","cards","others","biz","date","notes"].forEach(id=>{
    $(id).addEventListener("input",updateTotals);
    $(id).addEventListener("change",updateTotals);
    $(id).addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();focusNextInput(e.target)}});
  });
  $("saveBtn").addEventListener("click",saveToCloud);
  $("newBtn").addEventListener("click",()=>{clearForm();showSync("","")});
  $("addExtraBtn").addEventListener("click",()=>{const r=addExtraItem("","");r.querySelector("input").focus()});
  $("refreshBtn").addEventListener("click",renderHistory);
  updateTotals();renderHistory();
</script>
</body>
</html>
