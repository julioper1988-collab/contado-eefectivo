<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contador de Efectivo Paraguay</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .business-info {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .business-input,
        .date-input {
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            font-weight: 500;
        }

        .business-input {
            flex: 1;
            min-width: 200px;
            max-width: 300px;
        }

        .date-input {
            min-width: 180px;
        }

        .business-input:focus,
        .date-input:focus {
            outline: none;
            border-color: white;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
        }

        .total-display {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .total-display .label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .total-display .amount {
            font-size: 36px;
            font-weight: bold;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .denomination-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .denomination-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s;
        }

        .denomination-item:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .denomination-label {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group button {
            width: 35px;
            height: 35px;
            border: none;
            background: #667eea;
            color: white;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .input-group button:hover {
            background: #5568d3;
            transform: scale(1.1);
        }

        .input-group button:active {
            transform: scale(0.95);
        }

        .input-group input {
            flex: 1;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 8px;
            width: 60px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .subtotal {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
            font-weight: 500;
        }

        .extra-amount {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .extra-amount h3 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .extra-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .extra-input-group input[type="text"] {
            flex: 2;
            min-width: 200px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ffc107;
            border-radius: 8px;
        }

        .extra-input-group input[type="number"] {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ffc107;
            border-radius: 8px;
        }

        .extra-input-group input:focus {
            outline: none;
            border-color: #e0a800;
        }

        .extra-input-group button {
            padding: 12px 25px;
            background: #ffc107;
            color: #856404;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .extra-input-group button:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .actions button {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-save {
            background: #28a745;
            color: white;
        }

        .btn-save:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-history {
            background: #17a2b8;
            color: white;
        }

        .btn-history:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .btn-reset {
            background: #dc3545;
            color: white;
        }

        .btn-reset:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-copy {
            background: #28a745;
            color: white;
        }

        .btn-copy:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        /* Historial */
        .history-section {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px solid #667eea;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .history-header h3 {
            color: #667eea;
            font-size: 22px;
            margin: 0;
        }

        .btn-close-history {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        .btn-close-history:hover {
            background: #c82333;
        }

        .history-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .history-filters input {
            flex: 1;
            min-width: 150px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .history-filters button {
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .history-filters button:hover {
            background: #5a6268;
        }

        .history-list {
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .history-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .history-item-info {
            flex: 1;
        }

        .history-item-business {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .history-item-date {
            font-size: 14px;
            color: #666;
        }

        .history-item-total {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
        }

        .history-item-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .history-detail-group {
            font-size: 13px;
        }

        .history-detail-group strong {
            color: #667eea;
            display: block;
            margin-bottom: 5px;
        }

        .history-item-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .history-item-actions button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn-view {
            background: #17a2b8;
            color: white;
        }

        .btn-view:hover {
            background: #138496;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .history-actions {
            display: flex;
            gap: 10px;
        }

        .history-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-export {
            background: #28a745;
            color: white;
        }

        .btn-export:hover {
            background: #218838;
        }

        .btn-clear {
            background: #dc3545;
            color: white;
        }

        .btn-clear:hover {
            background: #c82333;
        }

        .no-records {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 16px;
        }

        /* Conteo General */
        .general-count-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 3px solid #667eea;
        }

        .general-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .general-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
        }

        .general-item:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .general-item label {
            display: block;
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .general-item input[type="number"] {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 10px;
        }

        .general-item input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .item-value {
            text-align: center;
            font-size: 16px;
            color: #28a745;
            font-weight: bold;
        }

        .item-value.large {
            font-size: 24px;
        }

        .efectivo-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .efectivo-item label {
            color: white;
        }

        .efectivo-item .item-value {
            color: white;
            font-size: 28px;
        }

        /* Resumen Final */
        .final-summary {
            background: white;
            padding: 25px;
            border-radius: 12px;
            border: 3px solid #667eea;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .summary-row:last-child {
            border-bottom: none;
        }

        .summary-row label {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .summary-row input {
            width: 250px;
            padding: 12px;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid #667eea;
            border-radius: 8px;
            text-align: right;
        }

        .summary-row input:focus {
            outline: none;
            border-color: #5568d3;
        }

        .summary-value {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
        }

        .total-row {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            margin: -25px -25px 15px -25px;
            border-radius: 12px 12px 0 0;
        }

        .total-row label {
            color: white;
            font-size: 24px;
        }

        .total-row .summary-value {
            color: white;
            font-size: 32px;
        }

        .discrepancy-row {
            background: #f8f9fa;
            padding: 20px;
            margin: 15px -25px -25px -25px;
            border-radius: 0 0 12px 12px;
        }

        .discrepancy-row label {
            font-size: 20px;
        }

        .discrepancy-positive {
            color: #28a745 !important;
        }

        .discrepancy-negative {
            color: #dc3545 !important;
        }

        .discrepancy-zero {
            color: #ffc107 !important;
        }

        /* Vista Compacta de Efectivo */
        .compact-cash-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #667eea;
        }

        .compact-cash-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .compact-column h4 {
            color: #667eea;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .compact-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
        }

        .compact-item:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .compact-item-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .compact-item-denom {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
            min-width: 100px;
        }

        .compact-item-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .compact-item-controls button {
            width: 32px;
            height: 32px;
            border: none;
            background: #667eea;
            color: white;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .compact-item-controls button:hover {
            background: #5568d3;
            transform: scale(1.1);
        }

        .compact-item-controls input {
            width: 50px;
            text-align: center;
            font-size: 15px;
            font-weight: bold;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            padding: 6px;
        }

        .compact-item-controls input:focus {
            outline: none;
            border-color: #667eea;
        }

        .compact-item-total {
            font-size: 15px;
            font-weight: bold;
            color: #28a745;
            min-width: 120px;
            text-align: right;
        }

        @media (max-width: 768px) {
            .compact-cash-grid {
                grid-template-columns: 1fr;
            }
        }

        .extra-amounts-list {
            margin-top: 15px;
            max-height: 150px;
            overflow-y: auto;
        }

        .extra-item {
            background: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #ffc107;
        }

        .extra-item-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .extra-item-description {
            font-weight: bold;
            color: #856404;
            font-size: 14px;
        }

        .extra-item-amount {
            color: #666;
            font-size: 16px;
            font-weight: 600;
        }

        .extra-item button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .extra-item button:hover {
            background: #c82333;
        }

        @media (max-width: 600px) {
            .denomination-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .header h1 {
                font-size: 22px;
            }

            .total-display .amount {
                font-size: 28px;
            }

            .actions {
                flex-direction: column;
            }
        }
    
    /* ‚òÅÔ∏è Nube / Backup (floating) */
    .cloud-fab{
        position: fixed;
        right: 18px;
        bottom: 18px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        border: none;
        background: #0f172a;
        color: #fff;
        font-size: 22px;
        cursor: pointer;
        box-shadow: 0 10px 25px rgba(0,0,0,.25);
        z-index: 9999;
    }
    .cloud-fab:hover{ transform: translateY(-2px); }
    .cloud-modal-backdrop{
        position: fixed; inset:0;
        background: rgba(0,0,0,.45);
        display:none;
        z-index: 9998;
    }
    .cloud-modal{
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: min(680px, calc(100vw - 28px));
        max-height: min(85vh, 720px);
        overflow: auto;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 25px 70px rgba(0,0,0,.35);
        display:none;
        z-index: 9999;
    }
    .cloud-modal header{
        padding: 16px 18px;
        display:flex;
        align-items:center;
        justify-content: space-between;
        border-bottom: 1px solid #e5e7eb;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color:#fff;
        border-radius: 16px 16px 0 0;
    }
    .cloud-modal header h2{ font-size: 18px; margin:0; }
    .cloud-close{
        background: rgba(255,255,255,.2);
        border: none;
        color:#fff;
        width: 36px;
        height: 36px;
        border-radius: 10px;
        cursor:pointer;
        font-size: 18px;
        display:flex;
        align-items:center;
        justify-content:center;
    }
    .cloud-body{ padding: 18px; }
    .cloud-grid{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    @media (max-width: 640px){ .cloud-grid{ grid-template-columns: 1fr; } }
    .cloud-card{
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        padding: 14px;
        background: #f8fafc;
    }
    .cloud-card h3{
        margin:0 0 10px 0;
        font-size: 15px;
        color:#0f172a;
    }
    .cloud-row{ display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    .cloud-row input, .cloud-row select{
        flex: 1;
        min-width: 220px;
        padding: 10px 12px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 14px;
        background:#fff;
    }
    .cloud-row input:focus, .cloud-row select:focus{
        outline:none; border-color:#667eea;
        box-shadow: 0 0 0 3px rgba(102,126,234,.15);
    }
    .cloud-actions{ display:flex; gap:10px; flex-wrap: wrap; margin-top: 10px; }
    .cloud-actions button, .cloud-actions label{
        padding: 10px 14px;
        border: none;
        border-radius: 10px;
        cursor:pointer;
        font-weight: 700;
        font-size: 14px;
        display:inline-flex;
        align-items:center;
        gap:8px;
    }
    .btn-primary{ background:#2563eb; color:#fff; }
    .btn-primary:hover{ background:#1d4ed8; }
    .btn-secondary{ background:#0f172a; color:#fff; }
    .btn-secondary:hover{ background:#0b1220; }
    .btn-ghost{ background:#e5e7eb; color:#111827; }
    .btn-ghost:hover{ background:#d1d5db; }
    .btn-danger{ background:#dc2626; color:#fff; }
    .btn-danger:hover{ background:#b91c1c; }
    .cloud-status{
        margin-top: 10px;
        padding: 10px 12px;
        background:#fff;
        border: 1px dashed #cbd5e1;
        border-radius: 12px;
        font-size: 13px;
        color:#0f172a;
        line-height: 1.35;
        white-space: pre-wrap;
    }
    .small-note{ font-size: 12px; color:#475569; margin-top: 6px; line-height: 1.3; }
    
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Contador de Efectivo</h1>
            <p>Paraguay - Guaran√≠es</p>
            
            <div class="business-info">
                <input type="text" id="businessName" placeholder="Nombre del Negocio" class="business-input">
                <input type="date" id="countDate" class="date-input">
            </div>
            
            <div class="total-display">
                <div class="label">TOTAL</div>
                <div class="amount" id="totalAmount">‚Ç≤ 0</div>
            </div>
        </div>

        <div class="content">
            <!-- Conteo General Section -->
            <div class="general-count-section" id="generalCountSection" style="display: none;">
                <div class="section-title">üìä Conteo General</div>
                
                <div class="general-grid">
                    <div class="general-item">
                        <label>üè¶ Bancos</label>
                        <input type="number" id="bancos" value="0" min="0" onchange="updateGeneralTotal()">
                        <div class="item-value">‚Ç≤ <span id="display-bancos">0</span></div>
                    </div>

                    <div class="general-item">
                        <label>üí≥ Tarjeta</label>
                        <input type="number" id="tarjeta" value="0" min="0" onchange="updateGeneralTotal()">
                        <div class="item-value">‚Ç≤ <span id="display-tarjeta">0</span></div>
                    </div>

                    <div class="general-item">
                        <label>üì± Wepa</label>
                        <input type="number" id="wepa" value="0" min="0" onchange="updateGeneralTotal()">
                        <div class="item-value">‚Ç≤ <span id="display-wepa">0</span></div>
                    </div>

                    <div class="general-item">
                        <label>üåê Infonet</label>
                        <input type="number" id="infonet" value="0" min="0" onchange="updateGeneralTotal()">
                        <div class="item-value">‚Ç≤ <span id="display-infonet">0</span></div>
                    </div>

                    <div class="general-item efectivo-item">
                        <label>üíµ Efectivo Contado</label>
                        <div class="item-value large">‚Ç≤ <span id="display-efectivo">0</span></div>
                    </div>
                </div>

                <!-- Resumen Final -->
                <div class="final-summary">
                    <div class="summary-row total-row">
                        <label>üí∞ TOTAL</label>
                        <div class="summary-value">‚Ç≤ <span id="totalGeneral">0</span></div>
                    </div>

                    <div class="summary-row">
                        <label>üìã Debo Tener</label>
                        <input type="number" id="deboTener" value="0" min="0" onchange="calculateDiscrepancy()" placeholder="Ingrese el valor esperado">
                    </div>

                    <div class="summary-row discrepancy-row" id="discrepancyRow">
                        <label>‚öñÔ∏è Descuadre</label>
                        <div class="summary-value" id="descuadreValue">‚Ç≤ 0</div>
                    </div>
                </div>
            </div>

            <!-- Conteo de Efectivo -->
            <div class="compact-cash-section">
                <div class="section-title">üíµ Conteo de Efectivo</div>
                <div class="compact-cash-grid">
                    <div class="compact-column">
                        <h4>üíµ Billetes</h4>
                        <div id="billetesCompact"></div>
                    </div>
                    <div class="compact-column">
                        <h4>ü™ô Monedas</h4>
                        <div id="monedasCompact"></div>
                    </div>
                </div>
            </div>

            <!-- Valores Adicionales -->
            <div class="extra-amount">
                <h3>‚ûï Agregar Valor Adicional</h3>
                <div class="extra-input-group">
                    <input type="text" id="extraDescription" placeholder="Descripci√≥n (ej: Tarjetas, Transferencias)">
                    <input type="number" id="extraValue" placeholder="Monto" min="0">
                    <button onclick="addExtraAmount()">Agregar</button>
                </div>
                <div class="extra-amounts-list" id="extraList"></div>
            </div>

            <!-- Acciones -->
            <div class="actions">
                <button class="btn-save" onclick="saveRecord()">üíæ Guardar Registro</button>
                <button class="btn-history" onclick="toggleHistory()">üìã Ver Historial</button>
                <button class="btn-reset" onclick="resetAll()">üîÑ Reiniciar</button>
            </div>

            <!-- Historial -->
            <div class="history-section" id="historySection" style="display: none;">
                <div class="history-header">
                    <h3>üìä Historial de Conteos</h3>
                    <button class="btn-close-history" onclick="toggleHistory()">‚úï</button>
                </div>
                <div class="history-filters">
                    <input type="text" id="filterBusiness" placeholder="Filtrar por negocio" onkeyup="filterHistory()">
                    <input type="date" id="filterDate" onchange="filterHistory()">
                    <button onclick="clearFilters()">Limpiar</button>
                </div>
                <div class="history-list" id="historyList"></div>
                <div class="history-actions">
                    <button class="btn-export" onclick="exportHistory()">üì• Exportar CSV</button>
                    <button class="btn-clear" onclick="clearHistory()">üóëÔ∏è Borrar Todo</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Denominaciones de Paraguay
        const billetes = [100000, 50000, 20000, 10000, 5000, 2000];
        const monedas = [1000, 500, 100, 50];

        

// =========================
// ‚òÅÔ∏è NUBE + BACKUP (v1)
// =========================
// Opcional: fijar Bin ID si quer√©s estilo "plug & play":
// const FIXED_BIN_ID = "PEGAR_BIN_ID_AQUI";
// const LOCK_BIN_ID = true;

const APP_ID = "cashCounterPY";
const DB_VERSION = 1;

function nowMs(){ return Date.now(); }

function cloudStatus(msg){
    const el = document.getElementById('cloudStatus');
    if (el) el.textContent = msg;
}

// Key/Bin persistidos por dispositivo (no se comparten)
function getJsonbinKey(){
    const saved = (localStorage.getItem('jsonbinKey_cash') || '').trim();
    if (saved) return saved;
    const input = (document.getElementById('jsonbinKeyInput')?.value || '').trim();
    if (input){
        localStorage.setItem('jsonbinKey_cash', input);
        return input;
    }
    return '';
}
function setJsonbinKey(val){
    if (val && val.trim()) localStorage.setItem('jsonbinKey_cash', val.trim());
}
function getKeyType(){
    return (localStorage.getItem('jsonbinKeyType_cash') || (document.getElementById('jsonbinKeyType')?.value || 'access')).trim();
}
function setKeyType(v){ if (v) localStorage.setItem('jsonbinKeyType_cash', v); }

function getBinId(){
    const fixed = (typeof FIXED_BIN_ID !== 'undefined' && FIXED_BIN_ID) ? FIXED_BIN_ID : '';
    if (fixed){
        localStorage.setItem('jsonbinId_cash', fixed);
        return fixed;
    }
    const saved = (localStorage.getItem('jsonbinId_cash') || '').trim();
    return saved || (document.getElementById('jsonbinIdInput')?.value || '').trim();
}
function setBinId(id){ if (id && id.trim()) localStorage.setItem('jsonbinId_cash', id.trim()); }

function cloudHeaders(){
    const key = getJsonbinKey();
    const keyType = (document.getElementById('jsonbinKeyType')?.value || getKeyType() || 'access');
    const headers = { "Content-Type": "application/json" };
    if (key){
        if (keyType === 'master') headers["X-Master-Key"] = key;
        else headers["X-Access-Key"] = key;
    }
    return headers;
}

// lastModified local (para comparar)
function getLocalLastModified(){
    return parseInt(localStorage.getItem('cash_lastModified') || '0', 10) || 0;
}
function setLocalLastModified(ms){
    localStorage.setItem('cash_lastModified', String(ms || nowMs()));
}

// Arma payload completo
function buildPayload(){
    return {
        businessName: document.getElementById('businessName')?.value || '',
        countDate: document.getElementById('countDate')?.value || '',
        counts,
        extraAmounts,
        history,
        generalCountData
    };
}

// Aplica payload recibido
function applyPayload(payload){
    if (!payload || typeof payload !== 'object') return false;

    if (payload.businessName !== undefined) document.getElementById('businessName').value = payload.businessName || '';
    if (payload.countDate !== undefined && payload.countDate) document.getElementById('countDate').value = payload.countDate;

    if (payload.counts && typeof payload.counts === 'object') counts = payload.counts;
    if (Array.isArray(payload.extraAmounts)) extraAmounts = payload.extraAmounts;
    if (Array.isArray(payload.history)) history = payload.history;
    if (payload.generalCountData && typeof payload.generalCountData === 'object') generalCountData = payload.generalCountData;

    // Re-render + persist
    renderCompactCash();
    renderExtraAmounts();

    // restaurar conteo general si corresponde
    const bn = (document.getElementById('businessName').value || '').trim().toLowerCase();
    const generalSection = document.getElementById('generalCountSection');
    if (generalSection){
        generalSection.style.display = (bn === 'conteo general') ? 'block' : 'none';
    }
    // set inputs de general
    ['bancos','tarjeta','wepa','infonet','deboTener'].forEach(f=>{
        const el = document.getElementById(f);
        if (!el) return;
        if (f === 'deboTener') el.value = generalCountData.deboTener || 0;
        else el.value = generalCountData[f] || 0;
    });

    updateTotal();
    updateGeneralTotal();

    renderHistory();

            saveHistory(); // usa localStorage 'cashCountHistory'
    return true;
}

// Protecciones
function isCloudEmpty(obj){
    if (!obj) return true;
    if (typeof obj !== 'object') return true;
    const payload = obj.payload || obj;
    if (!payload) return true;
    const hasHistory = Array.isArray(payload.history) && payload.history.length > 0;
    return !hasHistory;
}

// Debounce push
let pushTimer = null;
function scheduleCloudPush(reason="cambio"){
    if (pushTimer) clearTimeout(pushTimer);
    pushTimer = setTimeout(()=>cloudPush(reason), 1200);
}

// Pull
async function cloudPull(reason="manual"){
    const binId = getBinId();
    if (!binId){ cloudStatus("‚ùó Falta Bin ID."); return; }

    const headers = cloudHeaders();
    if (!headers["X-Access-Key"] && !headers["X-Master-Key"]){
        cloudStatus("‚ùó Falta API key (pegala arriba).");
        return;
    }

    cloudStatus("üì• Cargando desde la nube‚Ä¶ ("+reason+")");
    try{
        const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, { headers });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        // JSONBin devuelve { record: ... }
        let record = data && data.record ? data.record : null;

        // Compatibilidad con bins mal guardados: record.record
        if (record && record.record && !record.payload && !record.history){
            record = record.record;
        }

        const cloudLast = (record && record.lastModified) ? parseInt(record.lastModified,10) : 0;
        const localLast = getLocalLastModified();

        // nube vac√≠a => no pisa
        if (isCloudEmpty(record) && history.length > 0){
            cloudStatus("üõ°Ô∏è Nube vac√≠a; se mantiene local.");
            return;
        }

        if (cloudLast > localLast){
            const payload = record.payload ? record.payload : record;
            applyPayload(payload);
            setLocalLastModified(cloudLast || nowMs());
            cloudStatus("‚úÖ Datos aplicados desde la nube.");
        } else {
            cloudStatus("‚ÑπÔ∏è Nube no m√°s nueva que local; se mantiene local.");
        }
    } catch(e){
        cloudStatus("‚ùå Error cargando nube: " + (e?.message || e));
    }
}

// Push
async function cloudPush(reason="manual"){
    const binId = getBinId();
    if (!binId) { cloudStatus("‚ùó Falta Bin ID."); return; }

    const headers = cloudHeaders();
    if (!headers["X-Access-Key"] && !headers["X-Master-Key"]){
        cloudStatus("‚ùó Falta API key (pegala arriba).");
        return;
    }

    const payload = buildPayload();
    const localLast = nowMs();
    const body = {
        app: APP_ID,
        version: DB_VERSION,
        lastModified: localLast,
        payload
    };

    cloudStatus("üîÑ Sincronizando a la nube‚Ä¶ " + reason);
    try{
        const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
            method: "PUT",
            headers,
            body: JSON.stringify(body)
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        setLocalLastModified(localLast);
        cloudStatus("‚úÖ Sincronizado exitosamente.");
                // Confirmaci√≥n r√°pida (por si el servidor normaliza datos)
                setTimeout(()=>{
                    const bin = getBinId();
                    const key = getJsonbinKey();
                    if (bin && key) cloudPull("post-push");
                }, 1200);
                } catch(e){
        cloudStatus("‚ùå Error sincronizando nube: " + (e?.message || e));
    }
}

// =========================
// üõ°Ô∏è BACKUP DIARIO (local)
// =========================
const BACKUP_KEY = "cash_daily_backups_v1"; // localStorage
function todayKey(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
}
function loadBackups(){
    try{ return JSON.parse(localStorage.getItem(BACKUP_KEY) || "{}"); }catch{ return {}; }
}
function saveBackups(obj){
    localStorage.setItem(BACKUP_KEY, JSON.stringify(obj || {}));
}
function pruneBackups(obj, keep=30){
    const keys = Object.keys(obj || {}).sort().reverse();
    const kept = {};
    keys.slice(0, keep).forEach(k=> kept[k]=obj[k]);
    return kept;
}

function makeSnapshot(){
    return {
        savedAt: new Date().toISOString(),
        lastModified: getLocalLastModified(),
        payload: buildPayload()
    };
}

function backupDaily(force=false){
    const k = todayKey();
    const backups = loadBackups();
    if (!force && backups[k]) return false;
    backups[k] = makeSnapshot();
    const pruned = pruneBackups(backups, 30);
    saveBackups(pruned);
    refreshBackupSelect();
    return true;
}

function refreshBackupSelect(){
    const sel = document.getElementById('backupDaySelect');
    if (!sel) return;
    const backups = loadBackups();
    const keys = Object.keys(backups).sort().reverse();
    sel.innerHTML = keys.length ? keys.map(k=>`<option value="${k}">${k}</option>`).join('') : '<option value="">(sin backups)</option>';
}

function getSelectedBackup(){
    const sel = document.getElementById('backupDaySelect');
    const k = sel?.value || '';
    if (!k) return null;
    const backups = loadBackups();
    return backups[k] || null;
}

function downloadJson(filename, obj){
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

function restoreBackup(snapshot){
    if (!snapshot || !snapshot.payload) return false;
    applyPayload(snapshot.payload);
    setLocalLastModified(snapshot.lastModified || nowMs());
    backupDaily(true);
    scheduleCloudPush("restoreBackup");
    return true;
}

// =========================
// UI modal handlers
// =========================
function openCloudModal(){
    document.getElementById('cloudBackdrop').style.display = 'block';
    document.getElementById('cloudModal').style.display = 'block';
}
function closeCloudModal(){
    document.getElementById('cloudBackdrop').style.display = 'none';
    document.getElementById('cloudModal').style.display = 'none';
}

function initCloudUI() {
            // Si el modal todav√≠a no est√° en el DOM (por orden de carga), reintentar una vez.
            const fabTest = document.getElementById('cloudFab');
            if (!fabTest) { setTimeout(initCloudUI, 50); return; }

    const fab = document.getElementById('cloudFab');
    const closeBtn = document.getElementById('cloudClose');
    const back = document.getElementById('cloudBackdrop');
    fab?.addEventListener('click', openCloudModal);
    closeBtn?.addEventListener('click', closeCloudModal);
    back?.addEventListener('click', closeCloudModal);

    // Prefill key/bin/type
    const keySaved = (localStorage.getItem('jsonbinKey_cash') || '').trim();
    const binSaved = (localStorage.getItem('jsonbinId_cash') || '').trim();
    const typeSaved = (localStorage.getItem('jsonbinKeyType_cash') || 'access').trim();

    const keyInput = document.getElementById('jsonbinKeyInput');
    const binInput = document.getElementById('jsonbinIdInput');
    const typeSel = document.getElementById('jsonbinKeyType');

    if (typeSel) typeSel.value = typeSaved;
    if (keyInput && keySaved) keyInput.value = keySaved;
    if (binInput){
        const fixed = (typeof FIXED_BIN_ID !== 'undefined' && FIXED_BIN_ID) ? FIXED_BIN_ID : '';
        binInput.value = fixed || binSaved;
        if ((typeof LOCK_BIN_ID !== 'undefined' && LOCK_BIN_ID) && fixed){
            binInput.disabled = true;
            binInput.style.opacity = '0.85';
        }
    }

    keyInput?.addEventListener('blur', ()=> setJsonbinKey(keyInput.value));
    keyInput?.addEventListener('change', ()=> setJsonbinKey(keyInput.value));
    binInput?.addEventListener('blur', ()=> setBinId(binInput.value));
    binInput?.addEventListener('change', ()=> setBinId(binInput.value));
    typeSel?.addEventListener('change', ()=> setKeyType(typeSel.value));

    document.getElementById('btnPull')?.addEventListener('click', ()=>cloudPull("manual"));
    document.getElementById('btnPush')?.addEventListener('click', ()=>cloudPush("manual"));
    document.getElementById('btnCopyBin')?.addEventListener('click', async ()=>{
        const id = getBinId();
        if (!id){ cloudStatus("‚ùó No hay Bin ID para copiar."); return; }
        try{
            await navigator.clipboard.writeText(id);
            cloudStatus("üìã Bin ID copiado al portapapeles.");
        }catch{
            cloudStatus("‚ÑπÔ∏è No pude copiar autom√°tico. Bin: " + id);
        }
    });

    // Backups
    refreshBackupSelect();
    document.getElementById('btnBackupNow')?.addEventListener('click', ()=>{
        const ok = backupDaily(true);
        cloudStatus(ok ? "üíæ Backup guardado." : "‚ÑπÔ∏è No se guard√≥.");
    });
    document.getElementById('btnDownloadBackup')?.addEventListener('click', ()=>{
        const snap = getSelectedBackup();
        if (!snap){ cloudStatus("‚ùó No hay backup seleccionado."); return; }
        downloadJson(`backup-contador-efectivo-${todayKey()}.json`, snap);
        cloudStatus("‚¨áÔ∏è Backup descargado.");
    });
    document.getElementById('btnRestoreBackup')?.addEventListener('click', ()=>{
        const snap = getSelectedBackup();
        if (!snap){ cloudStatus("‚ùó No hay backup seleccionado."); return; }
        if (!confirm("¬øRestaurar este backup? Esto reemplaza tus datos actuales.")) return;
        const ok = restoreBackup(snap);
        cloudStatus(ok ? "‚ôªÔ∏è Backup restaurado." : "‚ùå No se pudo restaurar.");
    });

    // Export/Import full JSON
    document.getElementById('btnExportJson')?.addEventListener('click', ()=>{
        const dump = {
            app: APP_ID,
            exportedAt: new Date().toISOString(),
            lastModified: getLocalLastModified(),
            payload: buildPayload()
        };
        downloadJson(`contador-efectivo-export-${todayKey()}.json`, dump);
        cloudStatus("üì§ Exportado.");
    });

    document.getElementById('importJsonFile')?.addEventListener('change', (e)=>{
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ()=>{
            try{
                const obj = JSON.parse(reader.result);
                const payload = obj.payload || obj;
                applyPayload(payload);
                setLocalLastModified(obj.lastModified || nowMs());
                backupDaily(true);
                scheduleCloudPush("importJson");
                cloudStatus("üì• Importado OK.");
            }catch(err){
                cloudStatus("‚ùå Error importando: " + (err?.message || err));
            }
            e.target.value = "";
        };
        reader.readAsText(file);
    });
}

// Auto: backup diario cuando abr√≠s el sistema
function initSafety(){
            backupDaily(false);

            // Auto-pull "en vivo":
            // - pesta√±a visible: cada 5s
            // - segundo plano: cada 25s (los navegadores igual suelen limitar)
            let autoPullTimer = null;

            function startAutoPull(){
                if (autoPullTimer) clearInterval(autoPullTimer);
                const period = (document.visibilityState === 'visible') ? 5000 : 25000;
                autoPullTimer = setInterval(()=>{
                    const bin = getBinId();
                    const key = getJsonbinKey();
                    if (bin && key) cloudPull("auto");
                }, period);
            }

            // Pull al enfocarse (muy √∫til en m√≥vil)
            window.addEventListener('focus', ()=>{
                const bin = getBinId();
                const key = getJsonbinKey();
                if (bin && key) cloudPull("focus");
            });

            document.addEventListener('visibilitychange', ()=>{
                startAutoPull();
                if (document.visibilityState === 'visible'){
                    const bin = getBinId();
                    const key = getJsonbinKey();
                    if (bin && key) cloudPull("visible");
                }
            });

            startAutoPull();
        }

let counts = {};
        let extraAmounts = [];
        let history = [];
        let generalCountData = {
            bancos: 0,
            tarjeta: 0,
            wepa: 0,
            infonet: 0,
            deboTener: 0
        };

        // Inicializar
        function init() {
            renderCompactCash();
            setupCompactEnterNavigation();
            setupExtraAmountEnter();
            setupBusinessNameListener();
            loadHistory();
            renderHistory();
            setTodayDate();
            updateTotal();
            // Nube/Backups
            initCloudUI();
            initSafety();
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('countDate').value = today;
        }

        // Detectar cuando se escribe "Conteo General"
        function setupBusinessNameListener() {
            const businessInput = document.getElementById('businessName');
            businessInput.addEventListener('input', function() {
                const value = this.value.trim().toLowerCase();
                const generalSection = document.getElementById('generalCountSection');
                
                if (value === 'conteo general') {
                    generalSection.style.display = 'block';
                } else {
                    generalSection.style.display = 'none';
                }
            });
        }

        // Renderizar vista compacta de billetes y monedas
        function renderCompactCash() {
            renderCompactDenominations('billetesCompact', billetes);
            renderCompactDenominations('monedasCompact', monedas);
        }

        function renderCompactDenominations(containerId, denominations) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            denominations.forEach(value => {
                // Inicializar el contador si no existe
                if (counts[value] === undefined) {
                    counts[value] = 0;
                }
                
                const item = document.createElement('div');
                item.className = 'compact-item';
                item.innerHTML = `
                    <div class="compact-item-left">
                        <div class="compact-item-denom">‚Ç≤ ${formatNumber(value)}</div>
                        <div class="compact-item-controls">
                            <button onclick="changeCount(${value}, -1)">‚àí</button>
                            <input type="number" 
                                   id="compact-input-${value}" 
                                   value="${counts[value]}" 
                                   min="0"
                                   class="compact-denomination-input"
                                   onchange="updateCount(${value}, this.value)">
                            <button onclick="changeCount(${value}, 1)">+</button>
                        </div>
                    </div>
                    <div class="compact-item-total" id="compact-subtotal-${value}">‚Ç≤ ${formatNumber(counts[value] * value)}</div>
                `;
                container.appendChild(item);
            });

            setupCompactEnterNavigation();
        }

        // Configurar navegaci√≥n con Enter en vista compacta
        function setupCompactEnterNavigation() {
            const inputs = document.querySelectorAll('.compact-denomination-input');
            inputs.forEach((input, index) => {
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (index < inputs.length - 1) {
                            inputs[index + 1].focus();
                            inputs[index + 1].select();
                        } else {
                            document.getElementById('extraDescription').focus();
                        }
                    }
                });
            });
        }

        // Funciones de Conteo General
        function updateGeneralTotal() {
            // Actualizar displays individuales
            ['bancos', 'tarjeta', 'wepa', 'infonet'].forEach(field => {
                const value = parseInt(document.getElementById(field).value) || 0;
                generalCountData[field] = value;
                document.getElementById(`display-${field}`).textContent = formatNumber(value);
            });

            // Obtener total de efectivo contado
            const efectivoTotal = calculateCashTotal();
            document.getElementById('display-efectivo').textContent = formatNumber(efectivoTotal);

            // Calcular total general
            const totalGeneral = generalCountData.bancos + 
                                 generalCountData.tarjeta + 
                                 generalCountData.wepa + 
                                 generalCountData.infonet + 
                                 efectivoTotal;
            
            document.getElementById('totalGeneral').textContent = formatNumber(totalGeneral);

            // Actualizar tambi√©n el total principal
            document.getElementById('totalAmount').textContent = `‚Ç≤ ${formatNumber(totalGeneral)}`;

            // Recalcular descuadre
            calculateDiscrepancy();
        }

        function calculateCashTotal() {
            let total = 0;
            Object.keys(counts).forEach(denomination => {
                total += counts[denomination] * parseInt(denomination);
            });
            extraAmounts.forEach(item => {
                total += item.amount;
            });
            return total;
        }

        function calculateDiscrepancy() {
            generalCountData.deboTener = parseInt(document.getElementById('deboTener').value) || 0;
            
            const totalGeneral = parseInt(document.getElementById('totalGeneral').textContent.replace(/\./g, '')) || 0;
            const descuadre = totalGeneral - generalCountData.deboTener;
            
            const descuadreElement = document.getElementById('descuadreValue');
            descuadreElement.textContent = `‚Ç≤ ${formatNumber(Math.abs(descuadre))}`;
            
            // Cambiar color seg√∫n el descuadre
            descuadreElement.classList.remove('discrepancy-positive', 'discrepancy-negative', 'discrepancy-zero');
            
            if (descuadre > 0) {
                descuadreElement.classList.add('discrepancy-positive');
                descuadreElement.textContent = `+ ‚Ç≤ ${formatNumber(descuadre)}`;
            } else if (descuadre < 0) {
                descuadreElement.classList.add('discrepancy-negative');
                descuadreElement.textContent = `- ‚Ç≤ ${formatNumber(Math.abs(descuadre))}`;
            } else {
                descuadreElement.classList.add('discrepancy-zero');
                descuadreElement.textContent = `‚Ç≤ 0 (Cuadrado)`;
            }
        }

        function renderDenominations(containerId, denominations) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            denominations.forEach(value => {
                counts[value] = 0;
                const item = document.createElement('div');
                item.className = 'denomination-item';
                item.innerHTML = `
                    <div class="denomination-label">‚Ç≤ ${formatNumber(value)}</div>
                    <div class="input-group">
                        <button onclick="changeCount(${value}, -1)">-</button>
                        <input type="number" 
                               id="input-${value}" 
                               value="0" 
                               min="0"
                               class="denomination-input"
                               onchange="updateCount(${value}, this.value)">
                        <button onclick="changeCount(${value}, 1)">+</button>
                    </div>
                    <div class="subtotal" id="subtotal-${value}">‚Ç≤ 0</div>
                `;
                container.appendChild(item);
            });
        }

        // Configurar Enter en valores adicionales
        function setupExtraAmountEnter() {
            const descInput = document.getElementById('extraDescription');
            const valueInput = document.getElementById('extraValue');

            descInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    valueInput.focus();
                }
            });

            valueInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addExtraAmount();
                }
            });
        }

        function changeCount(denomination, change) {
            counts[denomination] = Math.max(0, counts[denomination] + change);
            
            // Actualizar vista compacta
            const compactInput = document.getElementById(`compact-input-${denomination}`);
            if (compactInput) {
                compactInput.value = counts[denomination];
            }
            
            updateSubtotal(denomination);
            updateTotal();
            updateGeneralTotal();
        }

        function updateCount(denomination, value) {
            counts[denomination] = Math.max(0, parseInt(value) || 0);
            
            // Sincronizar vista compacta
            const compactInput = document.getElementById(`compact-input-${denomination}`);
            if (compactInput) {
                compactInput.value = counts[denomination];
            }
            
            updateSubtotal(denomination);
            updateTotal();
            updateGeneralTotal();
        }

        function updateSubtotal(denomination) {
            const subtotal = counts[denomination] * denomination;
            
            // Actualizar vista compacta
            const compactSubtotal = document.getElementById(`compact-subtotal-${denomination}`);
            if (compactSubtotal) {
                compactSubtotal.textContent = `‚Ç≤ ${formatNumber(subtotal)}`;
            }
        }

        function addExtraAmount() {
            const descInput = document.getElementById('extraDescription');
            const valueInput = document.getElementById('extraValue');
            const description = descInput.value.trim() || 'Sin descripci√≥n';
            const value = parseInt(valueInput.value) || 0;
            
            if (value > 0) {
                extraAmounts.push({
                    description: description,
                    amount: value
                });
                renderExtraAmounts();
                updateTotal();
                updateGeneralTotal();
                descInput.value = '';
                valueInput.value = '';
                descInput.focus();
            }
        }

        function removeExtraAmount(index) {
            extraAmounts.splice(index, 1);
            renderExtraAmounts();
            updateTotal();
            updateGeneralTotal();
        }

        function renderExtraAmounts() {
            const list = document.getElementById('extraList');
            if (extraAmounts.length === 0) {
                list.innerHTML = '';
                return;
            }

            list.innerHTML = extraAmounts.map((item, index) => `
                <div class="extra-item">
                    <div class="extra-item-content">
                        <div class="extra-item-description">${item.description}</div>
                        <div class="extra-item-amount">‚Ç≤ ${formatNumber(item.amount)}</div>
                    </div>
                    <button onclick="removeExtraAmount(${index})">‚úï</button>
                </div>
            `).join('');
        }

        function updateTotal() {
            let total = 0;
            
            Object.keys(counts).forEach(denomination => {
                total += counts[denomination] * parseInt(denomination);
            });

            extraAmounts.forEach(item => {
                total += item.amount;
            });

            const businessName = document.getElementById('businessName').value.trim().toLowerCase();
            if (businessName !== 'conteo general') {
                document.getElementById('totalAmount').textContent = `‚Ç≤ ${formatNumber(total)}`;
            }
        }

        // Guardar registro
        function saveRecord() {
            const businessName = document.getElementById('businessName').value.trim();
            const countDate = document.getElementById('countDate').value;
            const isGeneralCount = businessName.toLowerCase() === 'conteo general';

            if (!businessName) {
                alert('Por favor, ingresa el nombre del negocio');
                document.getElementById('businessName').focus();
                return;
            }

            if (!countDate) {
                alert('Por favor, selecciona la fecha');
                return;
            }

            let total = 0;
            let recordData = {
                id: Date.now(),
                businessName: businessName,
                date: countDate,
                timestamp: new Date().toISOString(),
                counts: {...counts},
                extraAmounts: [...extraAmounts]
            };

            if (isGeneralCount) {
                const totalGeneral = parseInt(document.getElementById('totalGeneral').textContent.replace(/\./g, '')) || 0;
                total = totalGeneral;
                
                recordData.generalCount = {
                    bancos: generalCountData.bancos,
                    tarjeta: generalCountData.tarjeta,
                    wepa: generalCountData.wepa,
                    infonet: generalCountData.infonet,
                    deboTener: generalCountData.deboTener,
                    descuadre: totalGeneral - generalCountData.deboTener
                };
            } else {
                total = calculateTotal();
            }

            if (total === 0) {
                alert('El total no puede ser 0. Ingresa al menos un valor.');
                return;
            }

            recordData.total = total;
            history.unshift(recordData);
            saveHistory();
            
            alert('‚úÖ Registro guardado exitosamente!');
            resetAll(false);
        }

        function calculateTotal() {
            let total = 0;
            Object.keys(counts).forEach(denomination => {
                total += counts[denomination] * parseInt(denomination);
            });
            extraAmounts.forEach(item => {
                total += item.amount;
            });
            return total;
        }

        // Historial
        function toggleHistory() {
            const historySection = document.getElementById('historySection');
            if (historySection.style.display === 'none') {
                historySection.style.display = 'block';
                renderHistory();
            } else {
                historySection.style.display = 'none';
            }
        }

        function renderHistory(filteredHistory = null) {
            const historyList = document.getElementById('historyList');
            const records = filteredHistory || history;

            if (records.length === 0) {
                historyList.innerHTML = '<div class="no-records">No hay registros guardados</div>';
                return;
            }

            historyList.innerHTML = records.map(record => {
                let detailsHTML = '';

                if (record.generalCount) {
                    // Es un conteo general
                    const gc = record.generalCount;
                    
                    detailsHTML = `
                        <div class="history-detail-group">
                            <strong>Bancos:</strong> ‚Ç≤${formatNumber(gc.bancos)}<br>
                            <strong>Tarjeta:</strong> ‚Ç≤${formatNumber(gc.tarjeta)}<br>
                            <strong>Wepa:</strong> ‚Ç≤${formatNumber(gc.wepa)}<br>
                            <strong>Infonet:</strong> ‚Ç≤${formatNumber(gc.infonet)}
                        </div>
                        <div class="history-detail-group">
                            <strong>Debo Tener:</strong> ‚Ç≤${formatNumber(gc.deboTener)}<br>
                            <strong>Descuadre:</strong> ${gc.descuadre >= 0 ? '+' : ''}‚Ç≤${formatNumber(gc.descuadre)}
                        </div>
                    `;
                } else {
                    // Es un conteo normal
                    const denomDetails = Object.entries(record.counts)
                        .filter(([_, count]) => count > 0)
                        .map(([denom, count]) => `${count} x ‚Ç≤${formatNumber(denom)} = ‚Ç≤${formatNumber(count * denom)}`)
                        .join('<br>');

                    const extrasDetails = record.extraAmounts
                        .map(item => `${item.description}: ‚Ç≤${formatNumber(item.amount)}`)
                        .join('<br>');

                    detailsHTML = `
                        ${denomDetails ? `<div class="history-detail-group"><strong>Efectivo:</strong><br>${denomDetails}</div>` : ''}
                        ${extrasDetails ? `<div class="history-detail-group"><strong>Adicionales:</strong><br>${extrasDetails}</div>` : ''}
                    `;
                }

                return `
                    <div class="history-item">
                        <div class="history-item-header">
                            <div class="history-item-info">
                                <div class="history-item-business">${record.businessName}</div>
                                <div class="history-item-date">${formatDate(record.date)} - ${formatTime(record.timestamp)}</div>
                            </div>
                            <div class="history-item-total">‚Ç≤ ${formatNumber(record.total)}</div>
                        </div>
                        <div class="history-item-details">
                            ${detailsHTML}
                        </div>
                        <div class="history-item-actions">
                            <button class="btn-view" onclick="loadRecord(${record.id})">üëÅÔ∏è Ver</button>
                            <button class="btn-delete" onclick="deleteRecord(${record.id})">üóëÔ∏è Eliminar</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterHistory() {
            const businessFilter = document.getElementById('filterBusiness').value.toLowerCase();
            const dateFilter = document.getElementById('filterDate').value;

            let filtered = history;

            if (businessFilter) {
                filtered = filtered.filter(record => 
                    record.businessName.toLowerCase().includes(businessFilter)
                );
            }

            if (dateFilter) {
                filtered = filtered.filter(record => record.date === dateFilter);
            }

            renderHistory(filtered);
        }

        function clearFilters() {
            document.getElementById('filterBusiness').value = '';
            document.getElementById('filterDate').value = '';
            renderHistory();
        }

        function loadRecord(id) {
            const record = history.find(r => r.id === id);
            if (!record) return;

            document.getElementById('businessName').value = record.businessName;
            document.getElementById('countDate').value = record.date;

            counts = {...record.counts};
            extraAmounts = [...record.extraAmounts];

            // Re-renderizar la vista compacta con los nuevos valores
            renderCompactCash();

            renderExtraAmounts();

            // Si es conteo general, cargar esos datos tambi√©n
            if (record.generalCount) {
                const gc = record.generalCount;
                document.getElementById('bancos').value = gc.bancos;
                document.getElementById('tarjeta').value = gc.tarjeta;
                document.getElementById('wepa').value = gc.wepa;
                document.getElementById('infonet').value = gc.infonet;
                document.getElementById('deboTener').value = gc.deboTener;
                
                generalCountData = {
                    bancos: gc.bancos,
                    tarjeta: gc.tarjeta,
                    wepa: gc.wepa,
                    infonet: gc.infonet,
                    deboTener: gc.deboTener
                };
                
                updateGeneralTotal();
                document.getElementById('generalCountSection').style.display = 'block';
            }

            updateTotal();
            toggleHistory();

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteRecord(id) {
            if (confirm('¬øEst√°s seguro de eliminar este registro?')) {
                history = history.filter(r => r.id !== id);
                saveHistory();
                renderHistory();
            }
        }

        function clearHistory() {
            if (confirm('¬øEst√°s seguro de borrar todo el historial? Esta acci√≥n no se puede deshacer.')) {
                history = [];
                saveHistory();
                renderHistory();
            }
        }

        function exportHistory() {
            if (history.length === 0) {
                alert('No hay registros para exportar');
                return;
            }

            let csv = 'Negocio,Fecha,Hora,Total\n';
            history.forEach(record => {
                csv += `"${record.businessName}","${formatDate(record.date)}","${formatTime(record.timestamp)}","${record.total}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `historial-conteos-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function saveHistory() {
            localStorage.setItem('cashCountHistory', JSON.stringify(history));
            // Seguridad: backup + sync
            try { backupDaily(false); } catch(e) {}
            try { setLocalLastModified(nowMs()); } catch(e) {}
            try { scheduleCloudPush('saveHistory'); } catch(e) {}
        }

        function loadHistory() {
            const saved = localStorage.getItem('cashCountHistory');
            if (saved) {
                history = JSON.parse(saved);
            }
            if (!getLocalLastModified() && history.length) {
                setLocalLastModified(nowMs());
            }
        }

        function resetAll(confirmReset = true) {
            if (confirmReset && !window.confirm('¬øEst√°s seguro de que deseas reiniciar todo?')) {
                return;
            }

            Object.keys(counts).forEach(key => {
                counts[key] = 0;
            });
            
            extraAmounts = [];
            
            // Re-renderizar la vista compacta
            renderCompactCash();
            renderExtraAmounts();
            
            // Reset general count fields
            ['bancos', 'tarjeta', 'wepa', 'infonet', 'deboTener'].forEach(field => {
                const element = document.getElementById(field);
                if (element) element.value = 0;
            });
            
            generalCountData = {
                bancos: 0,
                tarjeta: 0,
                wepa: 0,
                infonet: 0,
                deboTener: 0
            };
            
            updateTotal();
            updateGeneralTotal();
            
            const firstInput = document.querySelector('.compact-denomination-input');
            if (firstInput) firstInput.focus();
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('es-PY', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            });
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('es-PY', { 
                hour: '2-digit', 
                minute: '2-digit'
            });
        }

        // Iniciar aplicaci√≥n
        document.addEventListener('DOMContentLoaded', () => { init(); });
</script>

    <!-- ‚òÅÔ∏è Nube / Backup -->
    <button class="cloud-fab" id="cloudFab" title="Nube / Backup">‚òÅÔ∏è</button>
    <div class="cloud-modal-backdrop" id="cloudBackdrop"></div>
    <div class="cloud-modal" id="cloudModal" role="dialog" aria-modal="true" aria-label="Nube y Backup">
        <header>
            <h2>‚òÅÔ∏è Nube & Backups</h2>
            <button class="cloud-close" id="cloudClose" title="Cerrar">‚úï</button>
        </header>
        <div class="cloud-body">
            <div class="cloud-grid">
                <div class="cloud-card">
                    <h3>üîë JSONBin</h3>
                    <div class="cloud-row" style="margin-bottom:10px;">
                        <select id="jsonbinKeyType">
                            <option value="access">X-Access-Key (recomendado)</option>
                            <option value="master">X-Master-Key (no recomendado en p√∫blico)</option>
                        </select>
                    </div>
                    <div class="cloud-row" style="margin-bottom:10px;">
                        <input id="jsonbinKeyInput" type="password" placeholder="Peg√° tu API Key (se guarda en este dispositivo)">
                    </div>
                    <div class="cloud-row" style="margin-bottom:10px;">
                        <input id="jsonbinIdInput" type="text" placeholder="Bin ID">
                    </div>
                    <div class="cloud-actions">
                        <button class="btn-primary" id="btnPull">‚¨áÔ∏è Traer</button>
                        <button class="btn-secondary" id="btnPush">‚¨ÜÔ∏è Subir</button>
                        <button class="btn-ghost" id="btnCopyBin">üìã Copiar Bin</button>
                    </div>
                    <div class="small-note">
                        Protecci√≥n: si la nube est√° vac√≠a, <b>no pisa</b> tus datos locales.
                    </div>
                </div>

                <div class="cloud-card">
                    <h3>üõ°Ô∏è Backup diario</h3>
                    <div class="cloud-actions">
                        <button class="btn-primary" id="btnBackupNow">üíæ Guardar backup ahora</button>
                        <button class="btn-ghost" id="btnDownloadBackup">‚¨áÔ∏è Descargar backup</button>
                        <button class="btn-danger" id="btnRestoreBackup">‚ôªÔ∏è Restaurar backup</button>
                    </div>
                    <div class="cloud-row" style="margin-top:10px;">
                        <select id="backupDaySelect"></select>
                    </div>
                    <div class="small-note">
                        Guarda hasta 30 d√≠as en este dispositivo. Descarg√° un .json para guardar afuera.
                    </div>
                </div>
            </div>

            <div class="cloud-card" style="margin-top:12px;">
                <h3>üì¶ Importar / Exportar (Rescate)</h3>
                <div class="cloud-actions">
                    <button class="btn-ghost" id="btnExportJson">üì§ Exportar datos (.json)</button>
                    <label class="btn-ghost" for="importJsonFile">
                        üì• Importar (.json)
                        <input type="file" id="importJsonFile" accept="application/json" style="display:none;">
                    </label>
                </div>
                <div class="cloud-status" id="cloudStatus">Estado: listo.</div>
            </div>
        </div>
    </div>

</body>
</html>
