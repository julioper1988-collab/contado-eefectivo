<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Control de Caja (Limpio)</title>
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,sans-serif;background:#0b1220;color:#eaf2ff}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .card{background:#0f1a2c;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;margin:12px 0}
    h1{margin:0 0 8px 0;font-size:22px}
    .muted{opacity:.75}
    label{display:block;font-size:12px;opacity:.8;margin:10px 0 6px}
    input,select,button,textarea{width:100%;padding:12px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0a111c;color:#eaf2ff;outline:none}
    textarea{min-height:80px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1;min-width:210px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media(max-width:740px){.grid{grid-template-columns:repeat(2,1fr)}}
    .denom{background:#0a111c;border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px}
    .denom .top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#0a111c}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap}
    .btnRow button{width:auto;flex:1;min-width:180px;cursor:pointer}
    .primary{background:#1c7ed6;border-color:rgba(255,255,255,.18)}
    .danger{background:#c92a2a;border-color:rgba(255,255,255,.18)}
    .warn{background:#d9480f;border-color:rgba(255,255,255,.18)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:13px}
    th{text-align:left;opacity:.8}
    .right{text-align:right}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Control de Caja (Limpio)</h1>
      <div class="muted">Contador de billetes y monedas + totales. Historial local por fecha y negocio. (Sin Supabase)</div>
      <div class="row">
        <div>
          <label>Negocio / Caja</label>
          <input id="biz" placeholder="Ej: Bodega, Asaditos, Conteo general" />
        </div>
        <div>
          <label>Fecha</label>
          <input id="date" type="date" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="pill"><b class="mono">Efectivo:</b> <span id="cashTotal" class="mono">0</span></div>
        <div class="pill"><b class="mono">Total general:</b> <span id="grandTotal" class="mono">0</span></div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px 0;font-size:18px">Billetes</h2>
      <div id="billsGrid" class="grid"></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px 0;font-size:18px">Monedas</h2>
      <div id="coinsGrid" class="grid"></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px 0;font-size:18px">Otros montos (se suman al total)</h2>
      <div class="row">
        <div>
          <label>Bancos</label>
          <input id="banks" inputmode="numeric" placeholder="0" />
        </div>
        <div>
          <label>Tarjetas / POS</label>
          <input id="cards" inputmode="numeric" placeholder="0" />
        </div>
        <div>
          <label>Otros</label>
          <input id="others" inputmode="numeric" placeholder="0" />
        </div>
      </div>
      <label>Detalle (opcional)</label>
      <textarea id="notes" placeholder="Ej: Ueno 1.200.000, Familiar 500.000, Bancard 800.000..."></textarea>
    </div>

    <div class="card">
      <div class="btnRow">
        <button class="primary" id="saveBtn">Guardar cierre</button>
        <button class="warn" id="loadBtn">Cargar (fecha + negocio)</button>
        <button class="danger" id="clearBtn">Borrar local (este cierre)</button>
      </div>
      <div class="muted" style="margin-top:10px">Guardado en este dispositivo (localStorage).</div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px 0;font-size:18px">Historial local</h2>
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Negocio</th>
            <th class="right">Total</th>
            <th class="right">Acciones</th>
          </tr>
        </thead>
        <tbody id="histBody"></tbody>
      </table>
    </div>
  </div>

<script>
  const BILLS = [100000, 50000, 20000, 10000, 5000, 2000, 1000, 500, 100];
  const COINS = [1000, 500, 100, 50];

  const $ = (id) => document.getElementById(id);
  const fmt = (n) => (Number(n||0)).toLocaleString("es-PY");
  const stateKey = "caja_limpio_v1";

  function todayISO(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return y + "-" + m + "-" + day;
  }

  function readStore(){
    const raw = localStorage.getItem(stateKey);
    return raw ? JSON.parse(raw) : { items: [] };
  }
  function writeStore(store){
    localStorage.setItem(stateKey, JSON.stringify(store));
  }

  function keyOf(date, biz){
    return date + "__" + (biz||"").trim().toLowerCase();
  }

  function numVal(v){
    const s = String(v||"").replaceAll(".","").replaceAll(",","").trim();
    const n = s === "" ? 0 : Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  function buildGrid(containerId, denoms, prefix){
    const grid = $(containerId);
    grid.innerHTML = "";
    denoms.forEach(d => {
      const wrap = document.createElement("div");
      wrap.className = "denom";
      wrap.innerHTML =
        '<div class="top">' +
          '<div class="pill"><b class="mono">' + fmt(d) + '</b></div>' +
          '<div class="pill"><span class="mono" id="' + prefix + '_t_' + d + '">0</span></div>' +
        '</div>' +
        '<label style="margin-top:10px">Cantidad</label>' +
        '<input id="' + prefix + '_c_' + d + '" inputmode="numeric" placeholder="0" />';
      grid.appendChild(wrap);

      const inp = wrap.querySelector("#" + prefix + "_c_" + d);
      inp.addEventListener("input", updateTotals);
      inp.addEventListener("keydown", (e) => {
        if(e.key === "Enter"){
          e.preventDefault();
          focusNextInput(inp);
        }
      });
    });
  }

  function allInputs(){
    return Array.from(document.querySelectorAll("input, textarea, select"))
      .filter(el => !el.disabled && el.type !== "hidden");
  }

  function focusNextInput(current){
    const list = allInputs();
    const i = list.indexOf(current);
    if(i >= 0 && i < list.length-1) list[i+1].focus();
  }

  function getCounts(prefix, denoms){
    const obj = {};
    denoms.forEach(d => { obj[d] = numVal($(prefix + "_c_" + d).value); });
    return obj;
  }

  function setCounts(prefix, denoms, counts){
    denoms.forEach(d => {
      $(prefix + "_c_" + d).value = (counts && counts[d] != null) ? String(counts[d]) : "";
    });
  }

  function sumCounts(denoms, counts){
    let total = 0;
    denoms.forEach(d => { total += Number(d) * numVal(counts[d]); });
    return total;
  }

  function updateTotals(){
    const bills = getCounts("b", BILLS);
    const coins = getCounts("m", COINS);

    BILLS.forEach(d => { $("b_t_" + d).textContent = fmt(Number(d) * numVal(bills[d])); });
    COINS.forEach(d => { $("m_t_" + d).textContent = fmt(Number(d) * numVal(coins[d])); });

    const cash = sumCounts(BILLS, bills) + sumCounts(COINS, coins);
    const banks = numVal($("banks").value);
    const cards = numVal($("cards").value);
    const others = numVal($("others").value);

    $("cashTotal").textContent = fmt(cash);
    $("grandTotal").textContent = fmt(cash + banks + cards + others);
  }

  function currentRecord(){
    const biz = $("biz").value.trim() || "Caja";
    const date = $("date").value || todayISO();

    const bills = getCounts("b", BILLS);
    const coins = getCounts("m", COINS);

    const banks = numVal($("banks").value);
    const cards = numVal($("cards").value);
    const others = numVal($("others").value);
    const notes = $("notes").value || "";

    const cash = sumCounts(BILLS, bills) + sumCounts(COINS, coins);
    const total = cash + banks + cards + others;

    return {
      id: keyOf(date, biz),
      date: date,
      biz: biz,
      bills: bills,
      coins: coins,
      banks: banks,
      cards: cards,
      others: others,
      notes: notes,
      cash: cash,
      total: total,
      updatedAt: new Date().toISOString()
    };
  }

  function loadRecord(rec){
    $("biz").value = rec.biz || "";
    $("date").value = rec.date || todayISO();
    setCounts("b", BILLS, rec.bills || {});
    setCounts("m", COINS, rec.coins || {});
    $("banks").value = rec.banks ? String(rec.banks) : "";
    $("cards").value = rec.cards ? String(rec.cards) : "";
    $("others").value = rec.others ? String(rec.others) : "";
    $("notes").value = rec.notes || "";
    updateTotals();
  }

  function renderHistory(){
    const store = readStore();
    const body = $("histBody");
    body.innerHTML = "";

    const items = (store.items || []).slice().sort((a,b) => (b.date||"").localeCompare(a.date||""));
    items.forEach(rec => {
      const tr = document.createElement("tr");
      tr.innerHTML =
        "<td>" + (rec.date || "") + "</td>" +
        "<td>" + (rec.biz || "") + "</td>" +
        '<td class="right mono">' + fmt(rec.total || 0) + "</td>" +
        '<td class="right">' +
          '<button data-act="open" data-id="' + rec.id + '" style="padding:8px 10px;border-radius:10px">Abrir</button>' +
          '<button data-act="del" data-id="' + rec.id + '" style="padding:8px 10px;border-radius:10px;margin-left:6px;background:#c92a2a;border-color:rgba(255,255,255,.18)">Borrar</button>' +
        "</td>";
      body.appendChild(tr);
    });

    body.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-id");
        const act = btn.getAttribute("data-act");
        const store2 = readStore();
        const idx = (store2.items||[]).findIndex(x => x.id === id);
        if(idx < 0) return;

        if(act === "open"){
          loadRecord(store2.items[idx]);
        } else if(act === "del"){
          store2.items.splice(idx,1);
          writeStore(store2);
          renderHistory();
        }
      });
    });
  }

  function saveCurrent(){
    const rec = currentRecord();
    const store = readStore();
    const idx = (store.items||[]).findIndex(x => x.id === rec.id);
    if(idx >= 0) store.items[idx] = rec;
    else store.items.push(rec);
    writeStore(store);
    renderHistory();
    alert("Guardado: " + rec.date + " · " + rec.biz);
  }

  function loadByKey(){
    const biz = $("biz").value.trim() || "Caja";
    const date = $("date").value || todayISO();
    const id = keyOf(date, biz);
    const store = readStore();
    const rec = (store.items||[]).find(x => x.id === id);
    if(!rec){
      alert("No existe ese cierre en este dispositivo.");
      return;
    }
    loadRecord(rec);
    alert("Cargado: " + date + " · " + biz);
  }

  function clearCurrentLocal(){
    const biz = $("biz").value.trim() || "Caja";
    const date = $("date").value || todayISO();
    const id = keyOf(date, biz);
    const store = readStore();
    const idx = (store.items||[]).findIndex(x => x.id === id);
    if(idx >= 0){
      store.items.splice(idx,1);
      writeStore(store);
      renderHistory();
      alert("Borrado local: " + date + " · " + biz);
    } else {
      alert("No había nada para borrar localmente.");
    }
  }

  $("date").value = todayISO();
  buildGrid("billsGrid", BILLS, "b");
  buildGrid("coinsGrid", COINS, "m");

  ["banks","cards","others","biz","date","notes"].forEach(id => {
    $(id).addEventListener("input", updateTotals);
    $(id).addEventListener("change", updateTotals);
    $(id).addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        focusNextInput(e.target);
      }
    });
  });

  $("saveBtn").addEventListener("click", saveCurrent);
  $("loadBtn").addEventListener("click", loadByKey);
  $("clearBtn").addEventListener("click", clearCurrentLocal);

  updateTotals();
  renderHistory();
</script>
</body>
</html>
