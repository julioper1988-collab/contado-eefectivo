<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Control de Caja</title>
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,sans-serif;background:#0b1220;color:#eaf2ff}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .card{background:#0f1a2c;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;margin:12px 0}
    h1{margin:0 0 8px 0;font-size:22px}
    .muted{opacity:.75}
    label{display:block;font-size:12px;opacity:.8;margin:10px 0 6px}
    input,select,button,textarea{width:100%;padding:12px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0a111c;color:#eaf2ff;outline:none;font-size:14px}
    textarea{min-height:80px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1;min-width:210px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media(max-width:740px){.grid{grid-template-columns:repeat(2,1fr)}}
    .denom{background:#0a111c;border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px}
    .denom .top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#0a111c}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap}
    .btnRow button{width:auto;flex:1;min-width:140px;cursor:pointer}
    .primary{background:#1c7ed6;border-color:rgba(255,255,255,.18)}
    .danger{background:#c92a2a;border-color:rgba(255,255,255,.18)}
    .warn{background:#d9480f;border-color:rgba(255,255,255,.18)}
    .success{background:#2b8a3e;border-color:rgba(255,255,255,.18)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:13px}
    th{text-align:left;opacity:.8}
    .right{text-align:right}
    .sync-status{display:inline-flex;align-items:center;gap:6px;padding:5px 12px;border-radius:999px;font-size:12px;margin-top:8px}
    .extra-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .extra-row input:first-child{flex:2}
    .extra-row input:nth-child(2){flex:1}
    .extra-row button{width:40px;min-width:40px;flex:none;padding:10px;border-radius:10px;background:#c92a2a;border-color:rgba(255,255,255,.18);cursor:pointer;font-size:16px}
    .sync-ok{background:rgba(43,138,62,.2);border:1px solid rgba(43,138,62,.4);color:#69db7c}
    .sync-err{background:rgba(201,42,42,.2);border:1px solid rgba(201,42,42,.4);color:#ff8787}
    .sync-loading{background:rgba(28,126,214,.2);border:1px solid rgba(28,126,214,.4);color:#74c0fc}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    .spinner{display:inline-block;width:12px;height:12px;border:2px solid rgba(255,255,255,.3);border-top-color:#74c0fc;border-radius:50%;animation:spin .6s linear infinite}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Control de Caja</h1>
      <div class="muted">Contador de billetes y monedas + totales. Sincronizado con Supabase ‚òÅÔ∏è</div>
      <div class="row">
        <div>
          <label>Negocio / Caja</label>
          <input id="biz" placeholder="Ej: Bodega, Asaditos, Conteo general" />
        </div>
        <div>
          <label>Fecha</label>
          <input id="date" type="date" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="pill"><b class="mono">Efectivo:</b> <span id="cashTotal" class="mono">0</span></div>
        <div class="pill"><b class="mono">Total general:</b> <span id="grandTotal" class="mono">0</span></div>
      </div>
      <div id="syncStatus"></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px 0;font-size:18px">Billetes</h2>
      <div id="billsGrid" class="grid"></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px 0;font-size:18px">Monedas</h2>
      <div id="coinsGrid" class="grid"></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px 0;font-size:18px">Otros montos (se suman al total)</h2>
      <div class="row">
        <div>
          <label>Bancos</label>
          <input id="banks" inputmode="numeric" placeholder="0" />
        </div>
        <div>
          <label>Tarjetas / POS</label>
          <input id="cards" inputmode="numeric" placeholder="0" />
        </div>
        <div>
          <label>Otros</label>
          <input id="others" inputmode="numeric" placeholder="0" />
        </div>
      </div>
      <label>Detalle (opcional)</label>
      <textarea id="notes" placeholder="Ej: Ueno 1.200.000, Familiar 500.000, Bancard 800.000..."></textarea>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px 0;font-size:18px">Montos adicionales</h2>
      <div id="extraItems"></div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-top:10px">
        <button class="success" id="addExtraBtn" style="width:auto;padding:8px 16px;font-size:13px">Ôºã Agregar l√≠nea</button>
        <div class="pill"><b class="mono">Subtotal:</b> <span id="extrasTotal" class="mono">0</span></div>
      </div>
    </div>

    <div class="card">
      <div class="btnRow">
        <button class="primary" id="saveBtn">‚òÅÔ∏è Guardar cierre</button>
        <button class="success" id="newBtn">‚ú® Nuevo cierre</button>
        <button class="warn" id="loadBtn">üì• Cargar (fecha + negocio)</button>
        <button class="danger" id="clearBtn">üóëÔ∏è Borrar cierre</button>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
        <h2 style="margin:0;font-size:18px">Historial</h2>
        <button class="success" id="refreshBtn" style="width:auto;padding:8px 16px;font-size:13px">üîÑ Actualizar</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Negocio</th>
            <th class="right">Total</th>
            <th class="right">Acciones</th>
          </tr>
        </thead>
        <tbody id="histBody"></tbody>
      </table>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
  // ‚îÄ‚îÄ Supabase config ‚îÄ‚îÄ
  const SUPABASE_URL = "https://gqgzluwptmgvzdewjusp.supabase.co";
  const SUPABASE_KEY = "sb_publishable_Gic4Jhw3keO6MyZtKV2nZA_jjXYiCnJ";

  let sb;
  try {
    sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  } catch(e) {
    console.error("Supabase init error:", e);
  }

  const TABLE = "caja_cierres";

  // ‚îÄ‚îÄ DOM helpers ‚îÄ‚îÄ
  const $ = (id) => document.getElementById(id);
  const fmt = (n) => (Number(n||0)).toLocaleString("es-PY");

  const BILLS = [100000, 50000, 20000, 10000, 5000, 2000, 1000, 500, 100];
  const COINS = [1000, 500, 100, 50];

  function todayISO(){
    const d = new Date();
    return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0") + "-" + String(d.getDate()).padStart(2,"0");
  }

  function keyOf(date, biz){
    return date + "__" + (biz||"").trim().toLowerCase();
  }

  function numVal(v){
    const s = String(v||"").replaceAll(".","").replaceAll(",","").trim();
    const n = s === "" ? 0 : Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  // ‚îÄ‚îÄ Sync status indicator ‚îÄ‚îÄ
  function showSync(type, msg){
    const el = $("syncStatus");
    if(type === "ok")      el.innerHTML = '<div class="sync-status sync-ok">‚úì ' + msg + '</div>';
    else if(type === "err") el.innerHTML = '<div class="sync-status sync-err">‚úó ' + msg + '</div>';
    else if(type === "loading") el.innerHTML = '<div class="sync-status sync-loading"><span class="spinner"></span> ' + msg + '</div>';
    else el.innerHTML = '';
  }

  // ‚îÄ‚îÄ Grid building ‚îÄ‚îÄ
  function buildGrid(containerId, denoms, prefix){
    const grid = $(containerId);
    grid.innerHTML = "";
    denoms.forEach(d => {
      const wrap = document.createElement("div");
      wrap.className = "denom";
      wrap.innerHTML =
        '<div class="top">' +
          '<div class="pill"><b class="mono">' + fmt(d) + '</b></div>' +
          '<div class="pill"><span class="mono" id="' + prefix + '_t_' + d + '">0</span></div>' +
        '</div>' +
        '<label style="margin-top:10px">Cantidad</label>' +
        '<input id="' + prefix + '_c_' + d + '" inputmode="numeric" placeholder="0" />';
      grid.appendChild(wrap);

      const inp = wrap.querySelector("#" + prefix + "_c_" + d);
      inp.addEventListener("input", updateTotals);
      inp.addEventListener("keydown", (e) => {
        if(e.key === "Enter"){ e.preventDefault(); focusNextInput(inp); }
      });
    });
  }

  function allInputs(){
    return Array.from(document.querySelectorAll("input, textarea, select"))
      .filter(el => !el.disabled && el.type !== "hidden");
  }

  function focusNextInput(current){
    const list = allInputs();
    const i = list.indexOf(current);
    if(i >= 0 && i < list.length-1) list[i+1].focus();
  }

  function getCounts(prefix, denoms){
    const obj = {};
    denoms.forEach(d => { obj[d] = numVal($(prefix + "_c_" + d).value); });
    return obj;
  }

  function setCounts(prefix, denoms, counts){
    denoms.forEach(d => {
      $(prefix + "_c_" + d).value = (counts && counts[d] != null) ? String(counts[d]) : "";
    });
  }

  function sumCounts(denoms, counts){
    let total = 0;
    denoms.forEach(d => { total += Number(d) * numVal(counts[d]); });
    return total;
  }

  // ‚îÄ‚îÄ Extra items (dynamic lines) ‚îÄ‚îÄ
  let extraCounter = 0;

  function addExtraItem(concepto, monto){
    extraCounter++;
    const id = "extra_" + extraCounter;
    const container = $("extraItems");
    const row = document.createElement("div");
    row.className = "extra-row";
    row.id = id;
    row.innerHTML =
      '<input type="text" placeholder="Concepto (ej: Ueno, Familiar...)" value="' + (concepto || "") + '" />' +
      '<input type="text" inputmode="numeric" placeholder="Monto" value="' + (monto || "") + '" />' +
      '<button type="button">‚úï</button>';
    container.appendChild(row);

    row.querySelector("input:nth-child(2)").addEventListener("input", updateTotals);
    row.querySelector("button").addEventListener("click", () => {
      row.remove();
      updateTotals();
    });
    updateTotals();
  }

  function getExtraItems(){
    const items = [];
    document.querySelectorAll("#extraItems .extra-row").forEach(row => {
      const inputs = row.querySelectorAll("input");
      const concepto = (inputs[0].value || "").trim();
      const monto = numVal(inputs[1].value);
      if(concepto || monto) items.push({ concepto, monto });
    });
    return items;
  }

  function setExtraItems(items){
    $("extraItems").innerHTML = "";
    extraCounter = 0;
    (items || []).forEach(it => addExtraItem(it.concepto, it.monto || 0));
  }

  function sumExtras(){
    let total = 0;
    document.querySelectorAll("#extraItems .extra-row").forEach(row => {
      const inp = row.querySelectorAll("input")[1];
      total += numVal(inp.value);
    });
    return total;
  }

  function updateTotals(){
    const bills = getCounts("b", BILLS);
    const coins = getCounts("m", COINS);

    BILLS.forEach(d => { $("b_t_" + d).textContent = fmt(Number(d) * numVal(bills[d])); });
    COINS.forEach(d => { $("m_t_" + d).textContent = fmt(Number(d) * numVal(coins[d])); });

    const cash = sumCounts(BILLS, bills) + sumCounts(COINS, coins);
    const banks = numVal($("banks").value);
    const cards = numVal($("cards").value);
    const others = numVal($("others").value);
    const extras = sumExtras();

    $("cashTotal").textContent = fmt(cash);
    $("extrasTotal").textContent = fmt(extras);
    $("grandTotal").textContent = fmt(cash + banks + cards + others + extras);
  }

  // ‚îÄ‚îÄ Record helpers ‚îÄ‚îÄ
  function currentRecord(){
    const biz = $("biz").value.trim() || "Caja";
    const date = $("date").value || todayISO();
    const bills = getCounts("b", BILLS);
    const coins = getCounts("m", COINS);
    const banks = numVal($("banks").value);
    const cards = numVal($("cards").value);
    const others = numVal($("others").value);
    const notes = $("notes").value || "";
    const extras = getExtraItems();
    const extrasTotal = sumExtras();
    const cash = sumCounts(BILLS, bills) + sumCounts(COINS, coins);
    const total = cash + banks + cards + others + extrasTotal;

    return {
      record_id: keyOf(date, biz),
      fecha: date,
      negocio: biz,
      bills: bills,
      coins: coins,
      bancos: banks,
      tarjetas: cards,
      otros: others,
      notas: notes,
      extras: extras,
      extras_total: extrasTotal,
      efectivo: cash,
      total: total,
      updated_at: new Date().toISOString()
    };
  }

  function loadRecord(rec){
    $("biz").value = rec.negocio || rec.biz || "";
    $("date").value = rec.fecha || rec.date || todayISO();
    setCounts("b", BILLS, rec.bills || {});
    setCounts("m", COINS, rec.coins || {});
    $("banks").value = rec.bancos || rec.banks ? String(rec.bancos || rec.banks) : "";
    $("cards").value = rec.tarjetas || rec.cards ? String(rec.tarjetas || rec.cards) : "";
    $("others").value = rec.otros || rec.others ? String(rec.otros || rec.others) : "";
    $("notes").value = rec.notas || rec.notes || "";
    setExtraItems(rec.extras || []);
    updateTotals();
  }

  // ‚îÄ‚îÄ Clear form ‚îÄ‚îÄ
  function clearForm(){
    setCounts("b", BILLS, {});
    setCounts("m", COINS, {});
    $("banks").value = "";
    $("cards").value = "";
    $("others").value = "";
    $("notes").value = "";
    $("biz").value = "";
    $("date").value = todayISO();
    setExtraItems([]);
    updateTotals();
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  // ‚îÄ‚îÄ Error message helper ‚îÄ‚îÄ
  function errMsg(e){
    if(!e) return "Error desconocido";
    if(typeof e === "string") return e;
    if(e.message) return e.message;
    if(e.details) return e.details;
    if(e.hint) return e.hint;
    try { return JSON.stringify(e); } catch(_){ return "Error desconocido"; }
  }

  // ‚îÄ‚îÄ Supabase operations ‚îÄ‚îÄ
  async function saveToCloud(){
    const rec = currentRecord();
    if(rec.total === 0){
      if(!confirm("El total es 0. ¬øGuardar de todos modos?")) return;
    }
    showSync("loading", "Guardando...");

    try {
      // Check if record exists
      const { data: existing } = await sb
        .from(TABLE)
        .select("record_id")
        .eq("record_id", rec.record_id)
        .maybeSingle();

      let result;
      if(existing){
        result = await sb.from(TABLE).update(rec).eq("record_id", rec.record_id);
      } else {
        result = await sb.from(TABLE).insert(rec);
      }

      if(result.error) throw result.error;
      showSync("ok", "‚úì Guardado: " + rec.fecha + " ¬∑ " + rec.negocio + " ¬∑ Gs. " + fmt(rec.total));
      clearForm();
      await renderHistory();
    } catch(e){
      console.error("Save error:", e);
      showSync("err", "Error al guardar: " + errMsg(e));
    }
  }

  async function loadFromCloud(){
    const biz = $("biz").value.trim() || "Caja";
    const date = $("date").value || todayISO();
    const id = keyOf(date, biz);

    showSync("loading", "Cargando...");

    try {
      const { data, error } = await sb
        .from(TABLE)
        .select("*")
        .eq("record_id", id)
        .maybeSingle();

      if(error) throw error;
      if(!data){
        showSync("err", "No existe ese cierre en la nube.");
        return;
      }
      loadRecord(data);
      showSync("ok", "Cargado: " + date + " ¬∑ " + biz);
    } catch(e){
      console.error("Load error:", e);
      showSync("err", "Error al cargar: " + errMsg(e));
    }
  }

  async function deleteFromCloud(){
    const biz = $("biz").value.trim() || "Caja";
    const date = $("date").value || todayISO();
    const id = keyOf(date, biz);

    if(!confirm("¬øBorrar cierre " + date + " ¬∑ " + biz + " de la nube?")) return;

    showSync("loading", "Borrando...");

    try {
      const { error } = await sb
        .from(TABLE)
        .delete()
        .eq("record_id", id);

      if(error) throw error;
      showSync("ok", "Borrado: " + date + " ¬∑ " + biz);
      await renderHistory();
    } catch(e){
      console.error("Delete error:", e);
      showSync("err", "Error al borrar: " + errMsg(e));
    }
  }

  async function renderHistory(){
    const body = $("histBody");

    try {
      const { data, error } = await sb
        .from(TABLE)
        .select("record_id, fecha, negocio, total")
        .order("fecha", { ascending: false })
        .limit(50);

      if(error) throw error;

      body.innerHTML = "";
      (data || []).forEach(rec => {
        const tr = document.createElement("tr");
        tr.innerHTML =
          "<td>" + (rec.fecha || "") + "</td>" +
          "<td>" + (rec.negocio || "") + "</td>" +
          '<td class="right mono">' + fmt(rec.total || 0) + "</td>" +
          '<td class="right">' +
            '<button data-act="open" data-id="' + rec.record_id + '" style="padding:8px 10px;border-radius:10px;cursor:pointer">Abrir</button> ' +
            '<button data-act="del" data-id="' + rec.record_id + '" style="padding:8px 10px;border-radius:10px;cursor:pointer;background:#c92a2a;border-color:rgba(255,255,255,.18)">Borrar</button>' +
          "</td>";
        body.appendChild(tr);
      });

      body.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          const act = btn.getAttribute("data-act");

          if(act === "open"){
            showSync("loading", "Cargando...");
            try {
              const { data: rec, error } = await sb
                .from(TABLE)
                .select("*")
                .eq("record_id", id)
                .maybeSingle();
              if(error) throw error;
              if(rec){
                loadRecord(rec);
                showSync("ok", "Cargado: " + rec.fecha + " ¬∑ " + rec.negocio);
              }
            } catch(e){
              showSync("err", "Error: " + errMsg(e));
            }
          } else if(act === "del"){
            if(!confirm("¬øBorrar este cierre de la nube?")) return;
            showSync("loading", "Borrando...");
            try {
              const { error } = await sb.from(TABLE).delete().eq("record_id", id);
              if(error) throw error;
              showSync("ok", "Borrado");
              await renderHistory();
            } catch(e){
              showSync("err", "Error: " + errMsg(e));
            }
          }
        });
      });
    } catch(e){
      console.error("History error:", e);
      body.innerHTML = '<tr><td colspan="4" style="color:#ff8787">Error al cargar historial: ' + errMsg(e) + '</td></tr>';
    }
  }

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
  $("date").value = todayISO();
  buildGrid("billsGrid", BILLS, "b");
  buildGrid("coinsGrid", COINS, "m");

  ["banks","cards","others","biz","date","notes"].forEach(id => {
    $(id).addEventListener("input", updateTotals);
    $(id).addEventListener("change", updateTotals);
    $(id).addEventListener("keydown", (e) => {
      if(e.key === "Enter"){ e.preventDefault(); focusNextInput(e.target); }
    });
  });

  $("saveBtn").addEventListener("click", saveToCloud);
  $("newBtn").addEventListener("click", () => { clearForm(); showSync("", ""); });
  $("addExtraBtn").addEventListener("click", () => addExtraItem("", ""));
  $("loadBtn").addEventListener("click", loadFromCloud);
  $("clearBtn").addEventListener("click", deleteFromCloud);
  $("refreshBtn").addEventListener("click", () => renderHistory());

  updateTotals();
  renderHistory();
</script>
</body>
</html>
